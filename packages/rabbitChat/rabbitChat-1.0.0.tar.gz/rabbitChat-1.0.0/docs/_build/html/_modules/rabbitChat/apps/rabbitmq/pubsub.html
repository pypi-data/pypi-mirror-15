

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>rabbitChat.apps.rabbitmq.pubsub &mdash; rabbitChat 1.0.0 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="rabbitChat 1.0.0 documentation" href="../../../../index.html"/>
        <link rel="up" title="Module code" href="../../../index.html"/> 

  
  <script src="../../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../../index.html" class="icon icon-home"> rabbitChat
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../features.html">Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../references.html">rabbitChat</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../../index.html">rabbitChat</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
      
    <li>rabbitChat.apps.rabbitmq.pubsub</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for rabbitChat.apps.rabbitmq.pubsub</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The pubsub module provides interface for the rabbitmq client.</span>

<span class="sd">It provides classes to create pika clients to connect to rabbitmq broker server, interact with</span>
<span class="sd">and publish/subscribe to rabbitmq via creating channels, methods to publish, subscribe/consume, </span>
<span class="sd">stop consuming, start publishing, start connection, stop connection, create channel, close channel, </span>
<span class="sd">acknowledge delivery by publisher, acknowledge receiving of messages by consumers, send basic ack, </span>
<span class="sd">basic cancel requests and also add callbacks for various other events.</span>
<span class="sd">&quot;&quot;&quot;</span>



<span class="kn">import</span> <span class="nn">pika.adapters</span>
<span class="kn">import</span> <span class="nn">pika</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="n">EXCHANGE</span> <span class="o">=</span> <span class="s1">&#39;chatexchange&#39;</span>
<span class="n">EXCHANGE_TYPE</span> <span class="o">=</span> <span class="s1">&#39;topic&#39;</span>
<span class="n">BINDING_KEY_DEFAULT</span> <span class="o">=</span> <span class="s1">&#39;public.*&#39;</span>
<span class="n">PORT</span> <span class="o">=</span> <span class="mi">5672</span>

<span class="n">LOGGER</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>




<div class="viewcode-block" id="RabbitMqClient"><a class="viewcode-back" href="../../../../modules/pubsub.html#rabbitChat.apps.rabbitmq.pubsub.RabbitMqClient">[docs]</a><span class="k">class</span> <span class="nc">RabbitMqClient</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a RabbitMQ Client using the TornadoConnection Adapter that will</span>
<span class="sd">    handle unexpected interactions with RabbitMQ such as channel and connection closures.</span>

<span class="sd">    If RabbitMQ closes the connection, it will reopen it. You should</span>
<span class="sd">    look at the output, as there are limited reasons why the connection may</span>
<span class="sd">    be closed, which usually are tied to permission related issues or</span>
<span class="sd">    socket timeouts.</span>

<span class="sd">    If the channel is closed, it will indicate a problem with one of the</span>
<span class="sd">    commands that were issued and that should surface in the output as well.</span>

<span class="sd">    It alos uses delivery confirmations and illustrates one way to keep track of</span>
<span class="sd">    messages that have been sent and if they&#39;ve been confirmed by RabbitMQ.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="RabbitMqClient.__init__"><a class="viewcode-back" href="../../../../modules/pubsub.html#rabbitChat.apps.rabbitmq.pubsub.RabbitMqClient.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">credentials</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a new instance of the consumer class, passing in the AMQP</span>
<span class="sd">        URL used to connect to RabbitMQ.</span>

<span class="sd">        :param credentials: credentials to connect to rabbitmq broker server</span>
<span class="sd">        :type credentials: pika.credentials.PlainCredentials</span>
<span class="sd">        :param params: connection paramaters used to connect with rabbitmq broker server</span>
<span class="sd">        :type params: pika.connection.ConnectionParameters</span>
<span class="sd">        :param queue: queue to be created after a channel is established which will be bound to an exchange</span>
<span class="sd">        :type queue: string - random long base64 url safe encoded string</span>

<span class="sd">        &quot;&quot;&quot;</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connected</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connecting</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_channel</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_closing</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_closed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_consumer_tag</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_deliveries</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_acked</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nacked</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_message_number</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_credentials</span> <span class="o">=</span> <span class="n">credentials</span> <span class="k">if</span> <span class="n">credentials</span> <span class="k">else</span> <span class="n">pika</span><span class="o">.</span><span class="n">PlainCredentials</span><span class="p">(</span><span class="s1">&#39;guest&#39;</span><span class="p">,</span> <span class="s1">&#39;guest&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span> <span class="o">=</span> <span class="n">params</span> <span class="k">if</span> <span class="n">params</span> <span class="k">else</span> <span class="n">pika</span><span class="o">.</span><span class="n">ConnectionParameters</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
                                                                           <span class="n">port</span><span class="o">=</span><span class="n">PORT</span><span class="p">,</span>
                                                                           <span class="n">virtual_host</span><span class="o">=</span><span class="s1">&#39;/&#39;</span><span class="p">,</span>
                                                                           <span class="n">credentials</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_credentials</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span> <span class="o">=</span> <span class="n">queue</span> <span class="k">if</span> <span class="n">queue</span> <span class="k">else</span> <span class="s1">&#39;queue-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">websocket</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_person</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clientid</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_participants</span> <span class="o">=</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="RabbitMqClient.connect"><a class="viewcode-back" href="../../../../modules/pubsub.html#rabbitChat.apps.rabbitmq.pubsub.RabbitMqClient.connect">[docs]</a>    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This method connects to RabbitMQ via the Torando Connectoin Adapter, returning the </span>
<span class="sd">        connection handle.</span>

<span class="sd">        When the connection is established, the on_connection_open method</span>
<span class="sd">        will be invoked by pika.</span>

<span class="sd">        :return: Returns a pika connection object which is a tornado connection object to rabbitmq server</span>
<span class="sd">        :rtype: pika.adapters.TornadoConnection</span>

<span class="sd">        &quot;&quot;&quot;</span>


        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connecting</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;[RabbitMqClient] Already connecting to RabbitMQ&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[RabbitMqClient] Connecting to RabbitMQ on localhost:5672, Object: </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connecting</span> <span class="o">=</span> <span class="bp">True</span>



        <span class="k">return</span> <span class="n">pika</span><span class="o">.</span><span class="n">adapters</span><span class="o">.</span><span class="n">TornadoConnection</span><span class="p">(</span><span class="n">parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span><span class="p">,</span>
                                               <span class="n">on_open_callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">on_connection_opened</span><span class="p">,</span>
                                               <span class="n">stop_ioloop_on_close</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span></div>



<div class="viewcode-block" id="RabbitMqClient.on_connection_opened"><a class="viewcode-back" href="../../../../modules/pubsub.html#rabbitChat.apps.rabbitmq.pubsub.RabbitMqClient.on_connection_opened">[docs]</a>    <span class="k">def</span> <span class="nf">on_connection_opened</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This method is called by pika once the connection to RabbitMQ has</span>
<span class="sd">        been established. It passes the handle to the connection object in</span>
<span class="sd">        case we need it, but in this case, we&#39;ll just mark it unused.</span>

<span class="sd">        :param connection: connection object created</span>
<span class="sd">        :type connection: pika.adapters.TornadoConnection</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[RabbitMqClient] Rabbitmq connection opened : </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">connection</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connected</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span> <span class="o">=</span> <span class="n">connection</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_on_connection_close_callback</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">open_channel</span><span class="p">()</span></div>



<div class="viewcode-block" id="RabbitMqClient.add_on_connection_close_callback"><a class="viewcode-back" href="../../../../modules/pubsub.html#rabbitChat.apps.rabbitmq.pubsub.RabbitMqClient.add_on_connection_close_callback">[docs]</a>    <span class="k">def</span> <span class="nf">add_on_connection_close_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This method adds an on close callback that will be invoked by pika</span>
<span class="sd">        when RabbitMQ closes the connection to the publisher unexpectedly.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">add_on_close_callback</span><span class="p">(</span><span class="n">callback_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">on_connection_closed</span><span class="p">)</span></div>




<div class="viewcode-block" id="RabbitMqClient.on_connection_closed"><a class="viewcode-back" href="../../../../modules/pubsub.html#rabbitChat.apps.rabbitmq.pubsub.RabbitMqClient.on_connection_closed">[docs]</a>    <span class="k">def</span> <span class="nf">on_connection_closed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">reply_code</span><span class="p">,</span> <span class="n">reply_text</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This method is invoked by pika when the connection to RabbitMQ is</span>
<span class="sd">        closed unexpectedly. Since it is unexpected, we will reconnect to</span>
<span class="sd">        RabbitMQ if it disconnects.</span>

<span class="sd">        :param  connection: The closed connection obj</span>
<span class="sd">        :type connection: pika.connection.Connection</span>
<span class="sd">        :param reply_code: The server provided reply_code if given</span>
<span class="sd">        :type reply_code: int </span>
<span class="sd">        :param reply_text: The server provided reply_text if given</span>
<span class="sd">        :type reply_text: str </span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s1">&#39;[RabbitMqClient] Rabbitmq connection closed unexpectedly : </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">connection</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_channel</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connecting</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connected</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_closing</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;[RabbitMqClient] connection already closing&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Connection closed, reopening in 5 seconds: reply_code : [</span><span class="si">%d</span><span class="s2">] : reply_text : </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">reply_code</span><span class="p">,</span> <span class="n">reply_text</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">add_timeout</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reconnect</span><span class="p">)</span></div>



<div class="viewcode-block" id="RabbitMqClient.reconnect"><a class="viewcode-back" href="../../../../modules/pubsub.html#rabbitChat.apps.rabbitmq.pubsub.RabbitMqClient.reconnect">[docs]</a>    <span class="k">def</span> <span class="nf">reconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Will be invoked by the IOLoop timer if the connection is</span>
<span class="sd">        closed. See the on_connection_closed method.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[RabbitMqClient] Reconnecting to rabbitmq&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_closing</span><span class="p">:</span>
            <span class="c1"># Create a new connection</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span></div>



<div class="viewcode-block" id="RabbitMqClient.close_connection"><a class="viewcode-back" href="../../../../modules/pubsub.html#rabbitChat.apps.rabbitmq.pubsub.RabbitMqClient.close_connection">[docs]</a>    <span class="k">def</span> <span class="nf">close_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This method closes the connection to RabbitMQ.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_closing</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;[RabbitMqClient] connection is already closing...&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_closing</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_connecting</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connected</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_channel</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_consumer_tag</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_consumer_tag</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">websocket</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">websocket</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_parameters</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_credentials</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_closed</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_person</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[RabbitMqClient] rabbitmq connection cosed&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="RabbitMqClient.open_channel"><a class="viewcode-back" href="../../../../modules/pubsub.html#rabbitChat.apps.rabbitmq.pubsub.RabbitMqClient.open_channel">[docs]</a>    <span class="k">def</span> <span class="nf">open_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open a new channel with RabbitMQ by issuing the Channel.Open RPC</span>
<span class="sd">        command. When RabbitMQ responds that the channel is open, the</span>
<span class="sd">        on_channel_open callback will be invoked by pika.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[RabbitMqClient] Creating a new channel for connection : </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_channel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">channel</span><span class="p">(</span><span class="n">on_open_callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">on_channel_open</span><span class="p">)</span></div>



<div class="viewcode-block" id="RabbitMqClient.on_channel_open"><a class="viewcode-back" href="../../../../modules/pubsub.html#rabbitChat.apps.rabbitmq.pubsub.RabbitMqClient.on_channel_open">[docs]</a>    <span class="k">def</span> <span class="nf">on_channel_open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This method is invoked by pika when the channel has been opened.</span>
<span class="sd">        The channel object is passed in so we can make use of it.</span>

<span class="sd">        Since the channel is now open, we&#39;ll declare the exchange to use.</span>

<span class="sd">        :param channel: The channel object</span>
<span class="sd">        :type channel: pika.channel.Channel </span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[RabbitMqClient] Channel opened : </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">channel</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_channel</span> <span class="o">=</span> <span class="n">channel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_on_channel_close_callback</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_exchange</span><span class="p">()</span></div>



<div class="viewcode-block" id="RabbitMqClient.close_channel"><a class="viewcode-back" href="../../../../modules/pubsub.html#rabbitChat.apps.rabbitmq.pubsub.RabbitMqClient.close_channel">[docs]</a>    <span class="k">def</span> <span class="nf">close_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Call to close the channel with RabbitMQ cleanly by issuing the</span>
<span class="sd">        Channel.Close RPC command.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[RabbitMqClient] Closing the channel... &#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_channel</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[RabbitMqClient] Channel closed : </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_channel</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[RabbitMqClient] Channel closed&#39;</span><span class="p">)</span></div>




<div class="viewcode-block" id="RabbitMqClient.add_on_channel_close_callback"><a class="viewcode-back" href="../../../../modules/pubsub.html#rabbitChat.apps.rabbitmq.pubsub.RabbitMqClient.add_on_channel_close_callback">[docs]</a>    <span class="k">def</span> <span class="nf">add_on_channel_close_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This method tells pika to call the on_channel_closed method if</span>
<span class="sd">        RabbitMQ unexpectedly closes the channel.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_channel</span><span class="o">.</span><span class="n">add_on_close_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_channel_closed</span><span class="p">)</span></div>



<div class="viewcode-block" id="RabbitMqClient.on_channel_closed"><a class="viewcode-back" href="../../../../modules/pubsub.html#rabbitChat.apps.rabbitmq.pubsub.RabbitMqClient.on_channel_closed">[docs]</a>    <span class="k">def</span> <span class="nf">on_channel_closed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">reply_code</span><span class="p">,</span> <span class="n">reply_text</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Invoked by pika when RabbitMQ unexpectedly closes the channel.</span>
<span class="sd">        Channels are usually closed if you attempt to do something that</span>
<span class="sd">        violates the protocol, such as re-declare an exchange or queue with</span>
<span class="sd">        different parameters. In this case, we&#39;ll close the connection</span>
<span class="sd">        to shutdown the object.</span>

<span class="sd">        :param channel: The closed channel</span>
<span class="sd">        :type channel: pika.channel.Channel</span>
<span class="sd">        :param reply_code: The numeric reason the channel was closed</span>
<span class="sd">        :type reply_code: int </span>
<span class="sd">        :param reply_text: The text reason the channel was closed</span>
<span class="sd">        :type reply_text: str </span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Channel </span><span class="si">%i</span><span class="s2"> was closed: reply_code : [</span><span class="si">%d</span><span class="s2">] reply_text : </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">channel</span><span class="p">,</span> <span class="n">reply_code</span><span class="p">,</span> <span class="n">reply_text</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span><span class="p">()</span></div>



<div class="viewcode-block" id="RabbitMqClient.setup_exchange"><a class="viewcode-back" href="../../../../modules/pubsub.html#rabbitChat.apps.rabbitmq.pubsub.RabbitMqClient.setup_exchange">[docs]</a>    <span class="k">def</span> <span class="nf">setup_exchange</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Setup the exchange on RabbitMQ by invoking the Exchange.Declare RPC</span>
<span class="sd">        command. When it is complete, the on_exchange_declareok method will</span>
<span class="sd">        be invoked by pika.</span>

<span class="sd">        &quot;&quot;&quot;</span>


        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[RabbitMqClient] Declaring exchange : </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">EXCHANGE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_channel</span><span class="o">.</span><span class="n">exchange_declare</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="n">EXCHANGE</span><span class="p">,</span>
                                       <span class="n">exchange_type</span><span class="o">=</span><span class="n">EXCHANGE_TYPE</span><span class="p">,</span>
                                       <span class="n">durable</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                       <span class="n">auto_delete</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                       <span class="n">nowait</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                       <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">on_exchange_declareok</span><span class="p">)</span></div>




<div class="viewcode-block" id="RabbitMqClient.on_exchange_declareok"><a class="viewcode-back" href="../../../../modules/pubsub.html#rabbitChat.apps.rabbitmq.pubsub.RabbitMqClient.on_exchange_declareok">[docs]</a>    <span class="k">def</span> <span class="nf">on_exchange_declareok</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Invoked by pika when RabbitMQ has finished the Exchange.Declare RPC</span>
<span class="sd">        command.</span>

<span class="sd">        :param frame: Exchange.DeclareOk response frame</span>
<span class="sd">        :type frame: pika.Frame.Method</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[RabbitMqClient] Exchange declared&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="mi">3</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setup_queue</span><span class="p">()</span></div>



<div class="viewcode-block" id="RabbitMqClient.setup_queue"><a class="viewcode-back" href="../../../../modules/pubsub.html#rabbitChat.apps.rabbitmq.pubsub.RabbitMqClient.setup_queue">[docs]</a>    <span class="k">def</span> <span class="nf">setup_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Setup the queue on RabbitMQ by invoking the Queue.Declare RPC</span>
<span class="sd">        command. When it is complete, the on_queue_declareok method will</span>
<span class="sd">        be invoked by pika.</span>

<span class="sd">        &quot;&quot;&quot;</span>


        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[RabbitMqClient] Declaring queue : for channel object : </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_channel</span><span class="o">.</span><span class="n">queue_declare</span><span class="p">(</span><span class="n">queue</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_queue</span><span class="p">,</span>
                                    <span class="n">durable</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                    <span class="n">exclusive</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                    <span class="n">auto_delete</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                    <span class="n">nowait</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                    <span class="n">arguments</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                                    <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">on_queue_declareok</span><span class="p">)</span></div>




<div class="viewcode-block" id="RabbitMqClient.on_queue_declareok"><a class="viewcode-back" href="../../../../modules/pubsub.html#rabbitChat.apps.rabbitmq.pubsub.RabbitMqClient.on_queue_declareok">[docs]</a>    <span class="k">def</span> <span class="nf">on_queue_declareok</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method_frame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method invoked by pika when the Queue.Declare RPC call made in</span>
<span class="sd">        setup_queue has completed. mand is complete, the on_bindok method will</span>
<span class="sd">        be invoked by pika.</span>

<span class="sd">        :param  method_frame: The Queue.DeclareOk frame</span>
<span class="sd">        :type method_frame: pika.frame.Method</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[RabbitMqClient] Queue declared&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="mi">4</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bind_queue</span><span class="p">(</span><span class="n">BINDING_KEY_DEFAULT</span><span class="p">)</span></div>



<div class="viewcode-block" id="RabbitMqClient.bind_queue"><a class="viewcode-back" href="../../../../modules/pubsub.html#rabbitChat.apps.rabbitmq.pubsub.RabbitMqClient.bind_queue">[docs]</a>    <span class="k">def</span> <span class="nf">bind_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">binding_key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;In this method we will bind the queue</span>
<span class="sd">        and exchange together with the routing key by issuing the Queue.Bind</span>
<span class="sd">        RPC command.</span>

<span class="sd">        :param  binding_key: The routing_key argument</span>
<span class="sd">        :type binding_key: string</span>

<span class="sd">        &quot;&quot;&quot;</span>


        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[RabbitMqClient] Binding </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1"> with </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="n">EXCHANGE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span><span class="p">,</span> <span class="n">binding_key</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_channel</span><span class="o">.</span><span class="n">queue_bind</span><span class="p">(</span><span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">on_bindok</span><span class="p">,</span>
                                 <span class="n">queue</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_queue</span><span class="p">,</span>
                                 <span class="n">exchange</span><span class="o">=</span><span class="n">EXCHANGE</span><span class="p">,</span>
                                 <span class="n">routing_key</span><span class="o">=</span><span class="n">binding_key</span><span class="p">,</span>
                                 <span class="n">nowait</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                 <span class="n">arguments</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span></div>




<div class="viewcode-block" id="RabbitMqClient.on_bindok"><a class="viewcode-back" href="../../../../modules/pubsub.html#rabbitChat.apps.rabbitmq.pubsub.RabbitMqClient.on_bindok">[docs]</a>    <span class="k">def</span> <span class="nf">on_bindok</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unused_frame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Invoked by pika when the Queue.Bind method has completed. At this</span>
<span class="sd">        point we will start consuming messages by calling start_consuming</span>
<span class="sd">        which will invoke the needed RPC commands to start the process.</span>
<span class="sd">        It will also set channel for publishing.</span>

<span class="sd">        :param  unused_frame: The Queue.BindOk response frame</span>
<span class="sd">        :type unused_frame: pika.frame.Method</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[RabbitMqClient] Queue bound&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="mi">5</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setup_publishing</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_consuming</span><span class="p">()</span></div>



<div class="viewcode-block" id="RabbitMqClient.setup_publishing"><a class="viewcode-back" href="../../../../modules/pubsub.html#rabbitChat.apps.rabbitmq.pubsub.RabbitMqClient.setup_publishing">[docs]</a>    <span class="k">def</span> <span class="nf">setup_publishing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        In this method we will setup the channel for publishing by making it available</span>
<span class="sd">        for delivery confirmations and publisher confirmations.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">enable_delivery_confirmations</span><span class="p">()</span></div>



<div class="viewcode-block" id="RabbitMqClient.enable_delivery_confirmations"><a class="viewcode-back" href="../../../../modules/pubsub.html#rabbitChat.apps.rabbitmq.pubsub.RabbitMqClient.enable_delivery_confirmations">[docs]</a>    <span class="k">def</span> <span class="nf">enable_delivery_confirmations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Send the Confirm.Select RPC method to RabbitMQ to enable delivery</span>
<span class="sd">        confirmations on the channel. The only way to turn this off is to close</span>
<span class="sd">        the channel and create a new one.</span>

<span class="sd">        When the message is confirmed from RabbitMQ, the</span>
<span class="sd">        on_delivery_confirmation method will be invoked passing in a Basic.Ack</span>
<span class="sd">        or Basic.Nack method from RabbitMQ that will indicate which messages it</span>
<span class="sd">        is confirming or rejecting.</span>

<span class="sd">        &quot;&quot;&quot;</span>


        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;[RabbitMqClient] Enabling delivery confirmation for publisher - Issuing Confirm.Select RPC command&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_channel</span><span class="o">.</span><span class="n">confirm_delivery</span><span class="p">(</span><span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">on_delivery_confirmation</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="mi">6</span></div>



<div class="viewcode-block" id="RabbitMqClient.on_delivery_confirmation"><a class="viewcode-back" href="../../../../modules/pubsub.html#rabbitChat.apps.rabbitmq.pubsub.RabbitMqClient.on_delivery_confirmation">[docs]</a>    <span class="k">def</span> <span class="nf">on_delivery_confirmation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method_frame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Invoked by pika when RabbitMQ responds to a Basic.Publish RPC</span>
<span class="sd">        command, passing in either a Basic.Ack or Basic.Nack frame with</span>
<span class="sd">        the delivery tag of the message that was published. The delivery tag</span>
<span class="sd">        is an integer counter indicating the message number that was sent</span>
<span class="sd">        on the channel via Basic.Publish. Here we&#39;re just doing house keeping</span>
<span class="sd">        to keep track of stats and remove message numbers that we expect</span>
<span class="sd">        a delivery confirmation of from the list used to keep track of messages</span>
<span class="sd">        that are pending confirmation.</span>

<span class="sd">        :param  method_frame: Basic.Ack or Basic.Nack frame</span>
<span class="sd">        :type method_frame: pika.frame.Method</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[RabbitMqClient] Publisher Delivery Confirmation received from broker&#39;</span><span class="p">)</span>

        <span class="n">confirmation_type</span> <span class="o">=</span> <span class="n">method_frame</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">NAME</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[RabbitMqClient] Received </span><span class="si">%s</span><span class="s1"> for delivery tag: </span><span class="si">%i</span><span class="s1"> &#39;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="n">confirmation_type</span><span class="p">,</span> <span class="n">method_frame</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">delivery_tag</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">confirmation_type</span> <span class="o">==</span> <span class="s1">&#39;ack&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_acked</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">confirmation_type</span> <span class="o">==</span> <span class="s1">&#39;nack&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_nacked</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_deliveries</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">method_frame</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">delivery_tag</span><span class="p">)</span>

        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[RabbitMqClient] Published </span><span class="si">%i</span><span class="s1"> messages, </span><span class="si">%i</span><span class="s1"> have yet to be confirmed, </span><span class="si">%i</span><span class="s1"> were acked and </span><span class="si">%i</span><span class="s1"> were nacked &#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_message_number</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_deliveries</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_acked</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nacked</span><span class="p">))</span></div>



<div class="viewcode-block" id="RabbitMqClient.publish"><a class="viewcode-back" href="../../../../modules/pubsub.html#rabbitChat.apps.rabbitmq.pubsub.RabbitMqClient.publish">[docs]</a>    <span class="k">def</span> <span class="nf">publish</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">routing_key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;If the class is not stopping, publish a message to RabbitMQ,</span>
<span class="sd">        appending a list of deliveries with the message number that was sent.</span>
<span class="sd">        This list will be used to check for delivery confirmations in the</span>
<span class="sd">        on_delivery_confirmations method.</span>

<span class="sd">        Once the message has been sent, schedule another message to be sent.</span>
<span class="sd">        The main reason I put scheduling in was just so you can get a good idea</span>
<span class="sd">        of how the process is flowing by slowing down and speeding up the</span>
<span class="sd">        delivery intervals by changing the PUBLISH_INTERVAL constant in the</span>
<span class="sd">        class.</span>

<span class="sd">        :param msg: Message to be published to Channel</span>
<span class="sd">        :tyep msg: string</span>
<span class="sd">        :param routing_key: Routing Key to direct message via the Exchange</span>
<span class="sd">        :type routing_key: string </span>

<span class="sd">        &quot;&quot;&quot;</span>


        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[RabbitMqClient] Publishing message&#39;</span><span class="p">)</span>

        <span class="n">properties</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">BasicProperties</span><span class="p">(</span><span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
                                          <span class="n">headers</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span>
                                          <span class="n">delivery_mode</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                          <span class="n">app_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_person</span>
                                          <span class="p">)</span>


        <span class="n">msg</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_channel</span><span class="o">.</span><span class="n">basic_publish</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="n">EXCHANGE</span><span class="p">,</span>
                                    <span class="n">routing_key</span><span class="o">=</span><span class="n">routing_key</span><span class="p">,</span>
                                    <span class="n">body</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span>
                                    <span class="n">properties</span><span class="o">=</span><span class="n">properties</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_message_number</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_deliveries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_message_number</span><span class="p">)</span>

        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[RabbitMqClient] Message published&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="RabbitMqClient.start_consuming"><a class="viewcode-back" href="../../../../modules/pubsub.html#rabbitChat.apps.rabbitmq.pubsub.RabbitMqClient.start_consuming">[docs]</a>    <span class="k">def</span> <span class="nf">start_consuming</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This method sets up the consumer by first calling</span>
<span class="sd">        add_on_cancel_callback so that the object is notified if RabbitMQ</span>
<span class="sd">        cancels the consumer. It then issues the Basic.Consume RPC command</span>
<span class="sd">        which returns the consumer tag that is used to uniquely identify the</span>
<span class="sd">        consumer with RabbitMQ. We keep the value to use it when we want to</span>
<span class="sd">        cancel consuming. The on_message method is passed in as a callback pika</span>
<span class="sd">        will invoke when a message is fully received.</span>

<span class="sd">        &quot;&quot;&quot;</span>


        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[RabbitMqClient] Started Consuming - Issuing consumer related RPC commands&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_on_cancel_callback</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_consumer_tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel</span><span class="o">.</span><span class="n">basic_consume</span><span class="p">(</span><span class="n">consumer_callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">on_message</span><span class="p">,</span>
                                                         <span class="n">queue</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_queue</span><span class="p">,</span>
                                                         <span class="n">no_ack</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                                         <span class="n">exclusive</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                                         <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status</span> <span class="o">=</span> <span class="mi">7</span>

        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[RabbitMqClient] self._status ==7 now&#39;</span><span class="p">)</span>
        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;[RabbitMqClient] rabbit client can now publish/consume msessag.</span><span class="se">\n</span><span class="s1">Sending first msg to websocket...&#39;</span><span class="p">)</span>

        <span class="n">m</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;msg_type&#39;</span><span class="p">:</span> <span class="s1">&#39;rabbitmqOK&#39;</span><span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">websocket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">m</span><span class="p">))</span></div>



<div class="viewcode-block" id="RabbitMqClient.add_on_cancel_callback"><a class="viewcode-back" href="../../../../modules/pubsub.html#rabbitChat.apps.rabbitmq.pubsub.RabbitMqClient.add_on_cancel_callback">[docs]</a>    <span class="k">def</span> <span class="nf">add_on_cancel_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a callback that will be invoked if RabbitMQ cancels the consumer</span>
<span class="sd">        for some reason. If RabbitMQ does cancel the consumer,</span>
<span class="sd">        on_consumer_cancelled will be invoked by pika.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_channel</span><span class="o">.</span><span class="n">add_on_cancel_callback</span><span class="p">(</span><span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">on_consumer_cancelled</span><span class="p">)</span></div>



<div class="viewcode-block" id="RabbitMqClient.on_consumer_cancelled"><a class="viewcode-back" href="../../../../modules/pubsub.html#rabbitChat.apps.rabbitmq.pubsub.RabbitMqClient.on_consumer_cancelled">[docs]</a>    <span class="k">def</span> <span class="nf">on_consumer_cancelled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method_frame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Invoked by pika when RabbitMQ sends a Basic.Cancel for a consumer</span>
<span class="sd">        receiving messages.</span>

<span class="sd">        :param  method_frame: The Basic.Cancel frame</span>
<span class="sd">        :type method_frame: pika.frame.Method</span>

<span class="sd">        &quot;&quot;&quot;</span>


        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s1">&#39;[RabbitMqClient] Consumer was cancelled remotely, shutting down.... sent method_frame </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">method_frame</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[RabbitMqClient] initating closing of channel&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close_channel</span><span class="p">()</span></div>



<div class="viewcode-block" id="RabbitMqClient.on_message"><a class="viewcode-back" href="../../../../modules/pubsub.html#rabbitChat.apps.rabbitmq.pubsub.RabbitMqClient.on_message">[docs]</a>    <span class="k">def</span> <span class="nf">on_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unused_channel</span><span class="p">,</span> <span class="n">basic_deliver</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Invoked by pika when a message is delivered from RabbitMQ. The</span>
<span class="sd">        channel is passed for your convenience. The basic_deliver object that</span>
<span class="sd">        is passed in carries the exchange, routing key, delivery tag and</span>
<span class="sd">        a redelivered flag for the message. The properties passed in is an</span>
<span class="sd">        instance of BasicProperties with the message properties and the body</span>
<span class="sd">        is the message that was sent.</span>

<span class="sd">        :param  unused_channel: The channel object</span>
<span class="sd">        :type unused_channel: pika.channel.Channel</span>
<span class="sd">        :param basic_deliver: The basic delivery object passed</span>
<span class="sd">        :type basic_deliver: pika.Spec.Basic.Deliver</span>
<span class="sd">        :param properties: The basic properties used to publish the message</span>
<span class="sd">        :type properties: pika.Spec.BasicProperties</span>
<span class="sd">        :param  body: The message body</span>
<span class="sd">        :type body: str|unicode</span>

<span class="sd">        &quot;&quot;&quot;</span>


        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[RabbitMqClient] Received message # </span><span class="si">%s</span><span class="s1"> from </span><span class="si">%s</span><span class="s1"> : </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="n">basic_deliver</span><span class="o">.</span><span class="n">delivery_tag</span><span class="p">,</span> <span class="n">properties</span><span class="o">.</span><span class="n">app_id</span><span class="p">,</span> <span class="n">body</span><span class="p">))</span>

        <span class="n">json_decoded_body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
        <span class="n">stage</span> <span class="o">=</span> <span class="n">json_decoded_body</span><span class="p">[</span><span class="s1">&#39;stage&#39;</span><span class="p">]</span>

        <span class="c1"># acknowledge the messge received</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acknowledge_message</span><span class="p">(</span><span class="n">basic_deliver</span><span class="o">.</span><span class="n">delivery_tag</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">stage</span> <span class="o">==</span> <span class="s1">&#39;stop&#39;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_person</span> <span class="o">==</span> <span class="n">json_decoded_body</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;[RabbitMqClient] skipping sending message to websocket since webscoket is closed.&#39;</span><span class="p">)</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[RabbitMqClient] initating closing of rabbitmq Client Connection.....&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;[RabbitMqClient] sending the message to corresponsding websoket: </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">websocket</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">websocket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">body</span><span class="p">)</span></div>




<div class="viewcode-block" id="RabbitMqClient.acknowledge_message"><a class="viewcode-back" href="../../../../modules/pubsub.html#rabbitChat.apps.rabbitmq.pubsub.RabbitMqClient.acknowledge_message">[docs]</a>    <span class="k">def</span> <span class="nf">acknowledge_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delivery_tag</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Acknowledge the message delivery from RabbitMQ by sending a</span>
<span class="sd">        Basic.Ack RPC method for the delivery tag.</span>

<span class="sd">        :param delivery_tag: The delivery tag from the Basic.Deliver frame</span>
<span class="sd">        :type delivery_tag: int </span>

<span class="sd">        &quot;&quot;&quot;</span>


        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[RabbitMqClient] Acknowledging message </span><span class="si">%i</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="n">delivery_tag</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_channel</span><span class="o">.</span><span class="n">basic_ack</span><span class="p">(</span><span class="n">delivery_tag</span><span class="p">)</span></div>



<div class="viewcode-block" id="RabbitMqClient.stop_consuming"><a class="viewcode-back" href="../../../../modules/pubsub.html#rabbitChat.apps.rabbitmq.pubsub.RabbitMqClient.stop_consuming">[docs]</a>    <span class="k">def</span> <span class="nf">stop_consuming</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tell RabbitMQ that you would like to stop consuming by sending the</span>
<span class="sd">        Basic.Cancel RPC command.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[RabbitMqClient] stopping consuming....&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel</span><span class="p">:</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[RabbitMqClient] Sending a Basic.Cancel RPC command to RabbitMQ&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_channel</span><span class="o">.</span><span class="n">basic_cancel</span><span class="p">(</span><span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">on_cancelok</span><span class="p">,</span>
                                       <span class="n">consumer_tag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_consumer_tag</span><span class="p">)</span></div>




<div class="viewcode-block" id="RabbitMqClient.on_cancelok"><a class="viewcode-back" href="../../../../modules/pubsub.html#rabbitChat.apps.rabbitmq.pubsub.RabbitMqClient.on_cancelok">[docs]</a>    <span class="k">def</span> <span class="nf">on_cancelok</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unused_frame</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This method is invoked by pika when RabbitMQ acknowledges the</span>
<span class="sd">        cancellation of a consumer. At this point we will close the channel.</span>
<span class="sd">        This will invoke the on_channel_closed method once the channel has been</span>
<span class="sd">        closed, which will in-turn close the connection.</span>

<span class="sd">        :param  unused_frame: The Basic.CancelOk frame</span>
<span class="sd">        :type unused_frame: pika.frame.Method</span>

<span class="sd">        &quot;&quot;&quot;</span>


        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[RabbitMqClient] RabbitMQ acknowledged the cancellation of the consumer&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_consumer_tag</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_consumer_tag</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">close_channel</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close_connection</span><span class="p">()</span></div>



<div class="viewcode-block" id="RabbitMqClient.start"><a class="viewcode-back" href="../../../../modules/pubsub.html#rabbitChat.apps.rabbitmq.pubsub.RabbitMqClient.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run the example consumer by connecting to RabbitMQ and then</span>
<span class="sd">        starting the IOLoop to block and allow the SelectConnection to operate.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[RabbitMqClient] starting the rabbitmq connection&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span></div>
        <span class="c1"># self._connection.ioloop.start()</span>



<div class="viewcode-block" id="RabbitMqClient.stop"><a class="viewcode-back" href="../../../../modules/pubsub.html#rabbitChat.apps.rabbitmq.pubsub.RabbitMqClient.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Cleanly shutdown the connection to RabbitMQ by stopping the consumer</span>
<span class="sd">        with RabbitMQ. When RabbitMQ confirms the cancellation, on_cancelok</span>
<span class="sd">        will be invoked by pika, which will then closing the channel and</span>
<span class="sd">        connection. The IOLoop is started again because this method is invoked</span>
<span class="sd">        when CTRL-C is pressed raising a KeyboardInterrupt exception. This</span>
<span class="sd">        exception stops the IOLoop which needs to be running for pika to</span>
<span class="sd">        communicate with RabbitMQ. All of the commands issued prior to starting</span>
<span class="sd">        the IOLoop will be buffered but not processed.</span>

<span class="sd">        &quot;&quot;&quot;</span>


        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[RabbitMqClient] Stopping RabbitMQClient object... : </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stop_consuming</span><span class="p">()</span>

        <span class="n">LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;[RabbitMqClient] RabbitMQClient Stopped&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="RabbitMqClient.status"><a class="viewcode-back" href="../../../../modules/pubsub.html#rabbitChat.apps.rabbitmq.pubsub.RabbitMqClient.status">[docs]</a>    <span class="k">def</span> <span class="nf">status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gives the status of the RabbitMQClient Connection.</span>


<span class="sd">        :return: Returns the current status of the connection</span>
<span class="sd">        :rtype: self._status</span>

<span class="sd">        &quot;&quot;&quot;</span>


        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status</span></div></div>






</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Anirban Roy DAs.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../../',
            VERSION:'1.0.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>