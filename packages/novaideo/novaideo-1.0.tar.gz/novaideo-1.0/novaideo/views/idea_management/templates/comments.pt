<div class="comments-container">
  <div class="comment-loading hide-bloc"
    tal:condition="origin">
    <img src="${request.static_url('novaideo:static/images/progress_bar.gif')}" width="30" alt="loading"/></div>
  <ul class="${(origin and 'commentulorigin') or 'commentul'}"
      i18n:domain="novaideo"
      data-nex_url="${(origin and batch.next_url)}"
      >
    <tal:loop repeat="(i, item) enumerate(comments)">
      <li class="commentli ${ (i>=level and not origin) and 'hide-bloc' or ''}" 
          data-association="${((comment.related_correlation is not None) and 'true') or 'false'}" 
          tal:define="diff view._datetimedelta(item['context'].created_at); comment item['context'];
                      picture getattr(comment.author, 'picture', None);
                      id 'comment-'+str(getattr(comment, '__oid__', 'None'));
                      attached_files comment.files">
         <div id="${id}" class="thumbnail right-caption span4 comment-data ${(comment.related_correlation is not None) and 'comment-association'}">
            <img tal:condition="picture is not None" class="img-circle" tal:attributes="src getattr(picture, 'profil', picture).url"  width="30"/>
            <img tal:condition="picture is None" class="img-circle" src="${request.static_url('novaideo:static/images/user.png')}" width="30"/>
            <div class="media-body comment-content">
              <div id="commentaction" class="pull-right">
                  <div tal:omit-tag="" tal:condition="'action' in item"  >
                   <a id="${item['action_id']}-btn" 
                      class="replay-action"
                      style="max-width: 300px;"
                      href="${item['action'].url(item['context'])}"
                      data-actionid ="${item['action_id']}" 
                      data-target="#${item['action_id']}"
                      data-updateurl="${item['actionurl_update']}"
                      data-toreplay="${'toreplay' in item}">
                       <span class="ion-chatbubbles"></span> ${item['action'].title}
                     </a>
                  </div>
              </div>
              <small class="comment-author" tal:define="diff_len  len(diff.keys())">
                <a tal:attributes="href request.resource_url(comment.author, '@@index')">${getattr(comment.author, 'title', comment.author.name)}</a> - 
                <div  tal:omit-tag="" tal:condition="diff"><span i18n:translate="">There is a</span>  
                  <span tal:condition="'days' in diff">${diff['days']} <span i18n:translate="">day(s)</span></span> 
                  <span tal:condition="'hours' in diff">${diff['hours']} <span i18n:translate="">hour(s)</span></span> 
                  <span tal:condition="'minutes' in diff">${diff['minutes']} <span i18n:translate="">minute(s)</span></span>
                  <span tal:condition="diff_len == 1 and 'seconds' in diff">${diff['seconds']} <span i18n:translate="">second(s)</span></span>
                </div>
                <span tal:condition="diff_len == 0" i18n:translate="">Now</span> - <span class="glyphicon glyphicon-question-sign"></span> <span i18n:translate="">Her intention:</span> 
                <span tal:condition="getattr(comment, 'intention', None)" i18n:translate="" tal:content="comment.intention"/>
              </small>

              <div class="content-text"  i18n:domain="novaideo"
                tal:define="files comment.get_attached_files_data();
                            len_files len(files)">
                <div class="row" tal:omit-tag="not files">
                    <div class="col-xs-12 col-md-8" tal:omit-tag="not files">
                      <div class="object-text">
                        <div>${structure:getattr(comment, 'formated_comment', comment.comment)}</div>
                      </div>
                    </div>
                    <div class="col-xs-12 col-md-4" tal:condition="files">
                        <div class="file-slider">
                          <div id="filecarousel-${id}" data-ride="carousel" data-interval="3000" class="carousel slide"> 
                            <div role="listbox" class="carousel-inner">
                                  <div tal:repeat="(i, source) enumerate(files)" class="item ${i==0 and 'active'}">
                                     <a tal:condition="source['type'] == 'img'" href="${source['content']}" target="_blank">
                                       <div 
                                        class="img-content"
                                        data-holder-rendered="true"
                                        style="
                                          background: rgba(0, 0, 0, 0) url(${source['content']}) no-repeat scroll center center / cover">
                                       </div>
                                     </a>
                                     <object tal:condition="source['type'] == 'flash'" width="300" height="90" codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=11,2,202,451" >
                                      <param name="movie" value="${source['content']}">
                                      <param name="quality" value="high">
                                      <embed src="${source['content']}" quality="high" class="img-content" 
                                        type="application/x-shockwave-flash" 
                                                  pluginspage="http://www.macromedia.com/go/getflashplayer">
                                      </embed>
                                     </object>
                                  </div>
                            </div>
                            <div tal:omit-tag="" tal:condition="len_files>1">
                              <a class="left carousel-control" href="#filecarousel-${id}" role="button" data-slide="prev">
                                <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
                                <span class="sr-only">Previous</span>
                              </a>
                              <a class="right carousel-control" href="#filecarousel-${id}" role="button" data-slide="next">
                                <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
                                <span class="sr-only">Next</span>
                              </a>
                            </div>
                          </div>
                          <script>
                            deform.addCallback(
                                 'filecarousel-${id}',
                                 function(oid) {
                                   $('#' + oid).carousel();
                                 }
                               );
                          </script>
                     </div>
                    </div>
                </div>

              </div>
              <div tal:condition="attached_files" class="attached-files">
                <small>
                 <blockquote class="attached_contents" tal:define="file_len len(attached_files)">
                   <dl >

                     <dt tal:condition="file_len>1"><span class="glyphicon glyphicon-paperclip"></span>  <span i18n:translate="">Attachments:</span></dt>
                     <dt tal:condition="file_len==1" ><span class="glyphicon glyphicon-paperclip"></span>  <span i18n:translate="">Attachment:</span></dt>
                   <dd>
                        <tal:loop repeat="f attached_files">
                          <a tal:attributes="href f.url">${f.title}</a>
                          <tal:separator condition="not: repeat['f'].end">, </tal:separator> 
                        </tal:loop>
                   </dd>
                 </dl>
                 </blockquote>
                </small>
              </div>
              <div tal:condition="comment.related_correlation is not None" id="related_contents">
                 <small tal:define="contents comment.related_correlation.targets">
                    <blockquote tal:define="contents_len len(contents)" class="attached_contents">
                      <dl >
                       <dt tal:condition="contents_len > 1"><span class="glyphicon glyphicon-link"></span> <span i18n:translate="">Associated contents:</span></dt>
                       <dt tal:condition="contents_len == 1" ><span class="glyphicon glyphicon-link"></span> <span i18n:translate="">Associated content:</span></dt>
                       <dd tal:condition="contents">
                         <tal:loop repeat="f contents">
                             <a tal:attributes="href request.resource_url(f, '@@index')"><span class="${getattr(f, 'icon', '')}"></span> ${f.title}</a>
                             <tal:separator condition="not: repeat['f'].end">, </tal:separator> 
                         </tal:loop>
                       </dd>
                      </dl>
                     </blockquote>
                 </small>
              </div>      
             <div class="pull-right" tal:define="commentlen len(comment.comments)">
                  <span tal:condition="commentlen-level > 0" 
                        class="comment-replay-nb closed"
                        onclick="javascript:replays_show(this);">
                      <small><span class="glyphicon glyphicon-chevron-down"></span> 
                      <span class="comment-replay-message-opened" i18n:translate="">View all <span i18n:name="commentlen">${commentlen}</span> responses</span>
                      <span class="comment-replay-message-closed hide-bloc" i18n:translate="">Hide responses</span>
                    </small>
                  </span>
                    <span tal:condition="commentlen-level <= 0 and commentlen > 0" 
                        class="comment-replay-nb disabled">
                        <small>
                            <span tal:condition="commentlen==1" class="comment-replay-message-opened" i18n:translate=""><span i18n:name="commentlen">${commentlen}</span> response</span>
                            <span tal:condition="commentlen>1" class="comment-replay-message-opened" i18n:translate=""><span i18n:name="commentlen">${commentlen}</span> responses</span>
                        </small>
                    </span>
              </div>
            </div>
         </div>
         <ul  class="commentul replay-bloc hide-bloc">
          <li>
            <div id="${item['action_id']}-replay" class="replay-body">
              <div class="comment-data ">
                 <div class="media-body">
                 </div>
              </div>  
              <script>
                  $(document).ready(function(){
                      $(${'\'#'+item['action_id']+'-replay\''}).on('hidden.replay', function (e) {
                         after_execution(${'\"'+item['actionurl_after']+'\"'})
                        })
                  });
             </script>    
            </div>
          </li>
         </ul>
        <div tal:define="(body, r, m, a) view._rendre_comments(comment.comments, current_user)" tal:replace="structure body" />
      </li>
    </tal:loop>
      <li class="commentli comment-preview hide-bloc" tal:define="current_picture getattr(current_user, 'picture', None)">
        <div class="thumbnail right-caption span4 comment-data">
            <img tal:condition="current_picture is not None" class="img-circle" tal:attributes="src getattr(current_picture, 'profil', current_picture).url"  width="30"/>
            <img tal:condition="current_picture is None" class="img-circle" src="${request.static_url('novaideo:static/images/user.png')}" width="30"/>
            <div class="media-body comment-content">
              <small class="comment-author">
                <a tal:attributes="href request.resource_url(current_user, '@@index')">${getattr(current_user, 'title', current_user.name)}</a> -
                <span i18n:translate="">Now</span> - <span class="glyphicon glyphicon-question-sign"></span> <span i18n:translate="">Her intention:</span>
              </small>
              <div class="comment-preview-text"></div>     
            </div>
         </div>
      </li>
  </ul>
</div>


