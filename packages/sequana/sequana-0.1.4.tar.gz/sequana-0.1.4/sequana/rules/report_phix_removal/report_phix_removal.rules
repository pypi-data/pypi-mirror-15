include: sm.modules['dag']     # Create DAG file
include: sm.modules['conda']   # Create requirements.txt(dependencies)

import sequana.snaketools as sm
cfg = sm.SequanaConfig.from_dict(config)
PROJECT = cfg.PROJECT


rule report_phix_removal:
    input:
        dag = "dag.svg",
        conda = "%s/requirements.txt" % PROJECT,
        fastqc_phix = "%s/fastqc_phix/fastqc.done" % PROJECT,
        fastqc_samples = "%s/fastqc_samples/fastqc.done" % PROJECT,
        fastq_stats = "%s/fastq_stats_samples/fastq_stats.done" % PROJECT,
        fastq_phix = "%s/fastq_stats_phix/fastq_stats.done" % PROJECT,
    output:
        touch("%s/report_phix_removal.html" % PROJECT),
        touch("%s/bwa_mem.html" % PROJECT),
        touch("%s/dag.svg" % PROJECT),
    params:
        outdir = PROJECT
    run:
        from sequana import report_main
        from sequana import report_phix
        from sequana import report_fastqc
        from sequana import report_fastq_stats

        # Main page
        s = report_main.SequanaReport(directory=params.outdir,
                    output_filename="report_phix_removal.html")
        s.jinja['description'] = """

        This is the output of the Phix removal pipeline. This pipeline
        search for a specific contaminant and provide as an output
        a pair of files with the contaminant (mapped) and without it (unmapped).
        The unmapped files are the files to be further analysed ( see links here
        below)

        """
        import os
        html = ""
        html += "<h3>Download Fastq without Phix: </h3>\n"
        for this in cfg.DATASET:
            basename = os.path.split(this)[1]
            name = basename.replace("_001.fastq.gz", ".unmapped.fastq.gz")
            link = "bwa_bam_to_fastq"+ os.sep + name
            html += '<br>-- <a href="%s">%s</a>' % (link, name)

        html += "<h3>Dowload Fastq with Phix </h3>\n"
        for this in cfg.DATASET:
            basename = os.path.split(this)[1]
            name = basename.replace("_001.fastq.gz", ".mapped.fastq.gz")
            link = "bwa_bam_to_fastq"+ os.sep + name
            html += '<br>-- <a href="%s">%s</a>' % (link, name)
        s.jinja['output'] = html

        s.create_report()

        # Phix page
        s = report_phix.PhixReport(output_filename="bwa_mem__phix.html",
                directory=params.outdir)
        s.input_filename = "%s/bwa_bam_to_fastq/bwa_mem_stats.json" % PROJECT
        s.jinja['main_link'] = 'report_phix_removal.html'
        s.create_report()

        # FastQC page
        s = report_fastqc.FastQCReport(
                PROJECT+ "/fastqc_phix", 
                output_filename="fastqc__phix.html",
                directory=params.outdir)
        s.jinja['main_link'] = 'report_phix_removal.html'
        s.create_report()

        s = report_fastqc.FastQCReport(
                PROJECT+ "/fastqc_samples", 
                output_filename="fastqc__samples.html",
                directory=params.outdir)
        s.jinja['main_link'] = 'report_phix_removal.html'
        s.create_report()

        # FastQ stats page
        s = report_fastq_stats.FastQStatsReport(
                PROJECT+ "/fastq_stats_phix", 
                output_filename="fastq_stats__phix.html",
                directory=params.outdir)
        s.jinja['main_link'] = 'report_phix_removal.html'
        s.create_report()

        s = report_fastq_stats.FastQStatsReport(
                PROJECT+ "/fastq_stats_samples", 
                output_filename="fastq_stats__samples.html",
                directory=params.outdir)
        s.jinja['main_link'] = 'report_phix_removal.html'
        s.create_report()

        # Copy some files
        shell("cp Snakefile %s/" % params.outdir)
        shell("cp config.yaml %s/" % params.outdir)
        shell("mv {input.dag} %s/" % params.outdir)
