$(document).ready(function(){function t(t,e){var a=(new XMLSerializer).serializeToString(t),r=e.getContext("2d"),i=new Image;return i.src="data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(a))),i.onload=function(){r.drawImage(i,0,0)},i}$(window).on("beforeunload",function(){$(window).scrollTop(0)}),$("#loading").fadeIn();var e,a,r,n,s,o,l,d,r,p=window.innerWidth,m=(window.innerHeight,.9*p),u=160,f=.8*u,g=20,v=45,y=17,b=colorbrewer.Set1[9],_=["#f0a3ff","#0075dc","#993f00","#4c005c","#191919","#005c31","#2bce48","#ffcc99","#808080","#94ffb5","#8f7c00","#9dcc00","#c20088","#003380","#ffa405","#ffa8bb","#426600","#ff0010","#5ef1f2","#00998f","#e0ff66","#740aff","#990000","#ffff80","#ffff00","#ff5005"],A=0,j=(new Array,$(window).width());$(window).resize(function(){$(this).width()!=j&&(j=$(this).width(),this.resizeTO&&clearTimeout(this.resizeTO),this.resizeTO=setTimeout(function(){$("#resize-warning-nav").show()},500))}),$("#resize-warning-exit").click(function(){$("#resize-warning-nav").hide()});var S="ws://"+location.host+"/pongsocket",k=new WebSocket(S);k.onmessage=function(t){var a=JSON.parse(t.data);if("pong-data"==a.type)for(r=a.pong,boolBarchart=r.barchart,sim_threshold=r.sim_threshold,$("#loading").fadeIn(),A+=r.qmatrices.length,n=r.popNames,s=r.popSizes,r.colors.length>0?b=r.colors:r.K_max>9&&(b=_),e=new Array,i=0;i<r.qmatrices.length;i++)majorID=r.qmatrices[i].major_mode_runid,plot=d3.select("#visualization").append("svg").attr("width",m).attr("height",u+15).attr("class","majorSVG").attr("id","plot"+majorID),e.push(plot),P(majorID,"no",null,null);else if("q-matrix"==a.type){var o=a.minor,l=a.minorID,d=a.is_first;"no"==o?z(d3.select("#plot"+a.name),a.K,a.matrix2d,a.minor,l,d,boolBarchart):z(d3.select("#plot"+a.name+"_minor"),a.K,a.matrix2d,a.minor,l,d,boolBarchart)}};var P=function(t,e,a,r){k.send(JSON.stringify({type:"get-qmatrix",name:t,minor:e,minorID:a,is_first:r}))},z=function(t,e,a,i,p,u,g){if("yes"==i)var v=.85*f;else var v=f;var y=a.length,_=r.qmatrices[e-r.K_min].color_perm;"yes"==i?(minorWidth=.75*m,o=.84*minorWidth,d=0,translate=.08*minorWidth):(o=.84*m,translate=.08*m,d=0),l=o/y;var w=r.qmatrices[e-r.K_min],j=w.major_mode_runid,S=Object.keys(w.modes),k=S.indexOf(j);k>-1&&S.splice(k,1);var K=L(w,S);0!=S.length&&"no"==i&&(A+=S.length+1,O(e,K)),"no"==i?(q(t,e,w),M(t,e,j)):C(t,w,p,u);var P=15,z=t.append("g").attr("transform","translate("+translate+", "+P+")"),N=z.append("svg").attr("class","plotSVG").attr("width",o).attr("id","plotSVG_"+j);if(g){var D=N.append("g").attr("class","indiv");for(c=0;c<e;c++){if("yes"==i&&"no"==u)var W=p+"_minorCluster"+_[c].toString();else var W="cluster"+(c+1).toString();var F=D.selectAll("rect."+W).data(a).enter().append("rect");F.attr({x:function(t,e){return d+e*l},y:function(t){for(h=0,x=c+1;x<e;x++)h+=t[x]*v;return h},width:l,height:function(t){return t[c]*v},"class":W}),F.style("fill",b[_[c]]).style("stroke",b[_[c]])}}else{var J=N.append("g").attr("class","clustergroup").attr("id","clusters_"+e),R=d3.scale.linear().range([0,o]).domain([0,y-1]),U=d3.scale.linear().range([0,v]).domain([0,1]);for(c=0;c<e;c++){var X=new Array;for(it=0;y>it;it++)X.push([it,a[it][c]]);if("yes"==i)var Q=p+"_minorCluster"+_[c].toString();else var Q="cluster_"+e+"_"+(c+1).toString();var Y=d3.svg.area().x(function(t){return R(t[0])}).y1(function(t){for(myy=t[1],clus=c+1;clus<e;clus++)myy+=a[t[0]][clus];return U(myy)}).y0(function(t){return U(0)}).interpolate("linear");J.append("svg:path").attr("class",Q).attr("id","clusters_"+e+"_"+c).attr("d",Y(X)).attr("stroke",b[_[c]]).attr("stroke-width",.3).attr("fill",b[_[c]])}}var Z=N.append("g").attr("class","pop");if("yes"==i)var tt=N.append("g").attr("class","minorPop"+e);var et=d,at=d,rt=d;if(null!=s)for(var it=0;it<s.length;it++){if(Z.call(G),"no"==i)var nt=Z.selectAll("rect").data(r.indiv_avg[j]).enter().append("rect").on("mouseover",G.show).on("mouseout",G.hide);else var nt=tt.selectAll("rect").data(r.indiv_avg[p]).enter().append("rect").on("mouseover",H.show).on("mouseout",H.hide);d3.select("#vizButton").on("click",function(){var t=new Array;for(popNum=1;popNum<s.length+1;popNum++){var e=".pop"+popNum.toString();"rgba(0, 0, 0, 0)"==d3.selectAll(e).style("fill")&&t.push(e)}d3.selectAll(".modal-title-viz").html(function(){var e="<h2>Visualizing populations:  </h2>",a="";for(it in t){var r=t[it].indexOf("o"),i=t[it].substring(r+2),s=n[i-1];a+=s+", "}return e+'<h3 style="color: rgb(70, 184, 218)">'+a.substring(0,a.length-2)+"</h3>"})}),d3.selectAll(".modes").on("click",function(){var t=this.id,e=t.split("-")[1];d3.selectAll(".minorPop"+e).call(H)}),nt.attr({"class":function(t,e){return"no"==i?"popNum pop"+(e+1):"minorPopNum minorPlot"+p},id:function(t,a){return"no"==i?"k"+e+"p"+(a+1):"minor_"+p+"_p"+(a+1)},x:function(t,e){var a=rt;return rt+=s[e]*l,a},y:0,width:function(t,e){return s[e]*l},height:v}),nt.style("fill","transparent"),nt.style("stroke","black"),et=at,at+=s[it]*l}if(d3.select("#whiteout"+e).on("click",function(){for(it in K)I(e,K[it],_,l,g)}),d3.selectAll(".popNum").on("click",function(){var t=this.id,e=t.indexOf("p"),a=t.substring(e+1);if(d3.event.shiftKey)d3.selectAll(".pop"+a.toString()).style("fill","transparent");else{d3.selectAll(".popNum").style("fill","grey").style("opacity","0.85");d3.selectAll(".pop"+a.toString()).style("fill","transparent")}}),$(document).mouseup(function(t){var e=$(".popNum"),a=$(".buttonDiv"),r=$("#vizButton"),i=$(".modal-content");e.is(t.target)||a.is(t.target)||r.is(t.target)||0!==e.has(t.target).length||0!==a.has(t.target).length||0!==r.has(t.target).length||e.css("fill","transparent"),i.is(t.target)||0!==i.has(t.target).length||$(".close").click()}),"no"==i&&a[0].length==r.K_max){var st=d3.select("#visualization").append("svg").attr("class","majorPopLabels").attr("width",m).attr("height",v+"px").append("g"),ot=B(st,"no",e),lt=d3.select("#visualization").select(".majorPopLabels");lt.attr("height",ot[0]).attr("width",ot[1])}if("yes"==i&&p==K[K.length-1]){var st=d3.select("#modal_body_"+e).append("svg").attr("class","minorPopLabels_"+e).attr("width",.75*m).attr("height",v+"px").append("g"),ot=B(st,"yes",e);V(e)}if(T(t,e,w,i,r.K_min),"no"==i)var dt=w.major_mode_runid;if("yes"==i)var dt=t[0][0].getAttribute("id").slice(4);$("#"+dt+"_print").click(function(e){e.preventDefault(),E(w,i,t,dt).print()}),$(document).ready(function(){$('[data-toggle="tooltip"]').tooltip()}),A--,0===A&&$("#loading").delay(200).fadeOut()},B=function(t,e,a){var r=translate,o=translate;translate;for(i in n){r=o,o+=s[i]*l;var d=r+.5*(o-r)-.5*g,c=y,p="translate("+d+","+c+")rotate("+v+")";"yes"==e?popid="minor_"+a+"_pop"+i:popid="major_pop"+i;t.append("text").text(n[i]).attr("class","x-axis").attr("transform",p).style("font-size","12px").style("font-family","Helvetica, sans-serif").attr("id",popid)}return"no"==e?N("major_pop","majorPopLabels"):void 0},N=function(t,e){return labelsvg=d3.select("."+e).select("g").node(),[labelsvg.getBBox().height+15,labelsvg.getBBox().width+labelsvg.getBBox().x+15]},O=function(t,e){var a=d3.select("body").append("div").attr("class","buttonDiv"),i=a.append("button").attr("class","modes btn btn-info btn-lg").attr("data-toggle","modal").attr("data-target","#modal-"+t.toString()).attr("id","button-"+t);i.style("position","absolute").style("top",129+(u+20)*(t-r.K_min)+98+"px").style("left",(translate+.84*m+20).toString()+"px"),i.html('<i class="fa fa-plus"></i> <span style="font-weight:bold; font-size:125%;">'+e.length+"</span>"),D(t,e,i,a,!1)},D=function(t,e,n,s,o){var l=s.append("div").attr("class","modal fade").attr("id",function(){return 0==o?"modal-"+t:"modal-viz"}).attr("role","dialog"),c=l.append("div").attr("class","modal-dialog"),p=c.append("div").attr("class","modal-content").attr("id","modal-content-"+t).style("width",(.75*m+80).toString()+"px").style("left",(d+10).toString()+"px"),f=p.append("div").attr("class","modal-header").attr("id",function(){return 0==o?"title"+t:"titleViz"});f.append("button").attr("type","button").attr("class","close").attr("data-dismiss","modal").text("x"),f.append("h2").attr("class",function(){return 0==o?"modal-title":"modal-title-viz"}).html(function(){return 0==o?"Clustering modes, K="+t:void 0});if(a=new Array,0==o){var g=p.append("div").attr("class","modal-header").attr("id","modal_header2_"+t);for(dirtyGray=0,i=0;i<e.length;i++){var h=e[i];if(minor_obj=r.qmatrices[t-r.K_min].modes[h],0!=minor_obj.gray_indices.length){dirtyGray=1;break}}if(dirtyGray){var v=g.append("label").attr("class","checkbox-inline");v.append("input").attr("type","checkbox").attr("class","check-input").attr("id","whiteout"+t),v.style("position","relative").style("top","4px");g.append("text").attr("class","checkbox-caption").text("\nCheck to highlight multimodality: ")}else 1==e.length?mymodestr="minor mode":mymodestr="minor modes",g.append("button").attr("type","submit").attr("class","btn btn-danger btn-small pull-right").attr("id","highlightMM_"+t).attr("data-toggle","tooltip").attr("data-placement","left").attr("title","Similarity between corresponding clusters in the major mode and "+mymodestr+" is less than the similarity threshold of "+r.sim_threshold+". Lower the similarity threshold in pong's command line to enable highlighting.").text("Why can't I highlight multimodality?");var y=r.qmatrices[t-r.K_min].major_mode_runid;plot=d3.select("#modal_header2_"+t).append("svg").attr("width",.75*m).attr("height",.95*u).attr("class","minorSVG-"+t).attr("id","plot"+y+"_minor"),a.push(plot),P(y,"yes",y,"yes")}p.append("div").attr("class","modal-body").attr("id",function(){return 0==o?"modal_body_"+t:"modal_body_viz"});if(0==o)for(i=0;i<e.length;i++){var h=e[i];plot=d3.select("#modal_body_"+t).append("svg").attr("width",.75*m).attr("height",.95*u).attr("class","minorSVG-"+t).attr("id","plot"+h+"_minor"),a.push(plot),P(h,"yes",h,"no")}},q=function(t,e,a){var r=a.total_runs,i=a.major_mode_runid,n=a.modes[i].runs_represented.length,s=.5*f+.5*g;label=t.append("text").text("K = "+e.toString()),label.attr("class","label").style("font","bold 20px Helvetica, sans-serif"),label.attr("x",0).attr("y",s),runs=t.append("text").text(n+"/"+r+" runs").attr("id","major_bigstring"),runs.attr("x",0).attr("y",s+25),runs.style("font","12px Helvetica, sans-serif");var o=document.getElementById("major_bigstring").getBBox(),l=o.width;l>translate&&(translate=l+5),avg_sim=a.modes[i].avg_sim,null!=avg_sim&&(sim=t.append("text").text("Avg pairwise similarity: "+avg_sim.toString().substring(0,5)),sim.attr("x",translate).attr("y",10),sim.style("fill","rgb(70, 184, 218)"),sim.style("font","bold 12px Helvetica, sans-serif"))},C=function(t,e,a,r){var i=e.total_runs,n=e.modes[a].runs_represented.length,s=.5*f*.85+.5*g;return"yes"==r&&(major=t.append("text").text("major mode"),major.attr("class","majorMinorLabel").attr("id","minor_bigstring"),major.attr("x",0).attr("y",s-38-15),major.style("font","bold 14px Helvetica, sans-serif")),83.609>translate&&(translate=88.609),label=t.append("text").text(a),label.attr("class","label"),label.attr("x",0).attr("y",s-26),label.style("font","20px Helvetica, sans-serif"),rep=t.append("text").text("represents"),rep.attr("x",0).attr("y",s+14-26),rep.style("font","12px Helvetica, sans-serif"),runs=t.append("text").text(n+"/"+i+" runs"),runs.attr("class","minorRun"),runs.attr("x",0).attr("y",s+30-26),runs.style("font","12px Helvetica, sans-serif"),avg_sim=e.modes[a].avg_sim,null!=avg_sim&&(sim=t.append("text").text("Avg pairwise similarity:"+avg_sim.toString().substring(0,5)),sim.attr("class","avg_sim"),sim.attr("x",translate).attr("y",10),sim.style("fill","rgb(70, 184, 218)"),sim.style("font","bold 12px Helvetica, sans-serif")),0},L=function(t,e){var a={};for(var r in e){var i=e[r],n=t.modes[i].runs_represented.length;a[i]=n}var s=Object.keys(a).map(function(t){return[t,a[t]]});s.sort(function(t,e){return e[1]-t[1]});var o=new Array;for(var r in s)o.push(s[r][0]);return o},I=function(t,e,a,n,s){var o=r.qmatrices[t-r.K_min].modes[e];if(null!=o.gray_indices){var l=o.gray_indices;for(i in o.gray_indices){var d=a[l[i]],c="."+e+"_minorCluster"+d.toString(),p=d3.select("#modal_body_"+t).select(".downloadModalPDF");s?"visible"==d3.selectAll(c).style("visibility")?(d3.selectAll(c).style("visibility","hidden"),p.classed("btn btn-primary",!0).text("Print highlighting multimodality at K="+t)):(d3.selectAll(c).style("visibility","visible"),p.classed("btn-primary",!1).text("Print all modes at K="+t)):"white"!=d3.selectAll(c).attr("fill")?(d3.selectAll(c).attr("fill","white").attr("stroke","white"),p.classed("btn btn-primary",!0).text("Print highlighting multimodality at K="+t)):(d3.selectAll(c).attr("fill",b[a[l[i]]]).attr("stroke",b[a[l[i]]]),p.classed("btn-primary",!1).text("Print all modes at K="+t))}}},M=function(t,e){var a=Math.round(1e3*r.qmatrices[e-r.K_min].avg_sim_bt_modes)/1e3;null!=a&&(simMode=d3.select("#title"+e).append("h4").text("\nAvg pairwise similarity among modes = "+a))},G=d3.tip().direction("s").attr("class","d3-tip").offset(function(t,e){var a=d3.transform(d3.select(this.parentNode.parentNode.parentNode).attr("transform"));return[a.translate[1],0]}).html(function(t,e){var a=t.length,i=r.qmatrices[a-r.K_min].color_perm,o='<div class="text-center"><strong>'+n[e]+"</strong><br>"+s[e]+" samples</div><br>";o+="<div><ul>";for(var l=[],d=0;a>d;d++)l.push({datum:t[d],color:b[i[d]]});return l.sort(function(t,e){return t.datum>e.datum?-1:t.datum==e.datum?0:1}),l.forEach(function(t,e){var a=Math.round(1e3*t.datum)/10,r=t.color;a>=.5&&(o+='<i class="fa fa-circle" style="color: '+r+' "></i>',o+="&nbsp;<strong> "+a+"%</strong></li><br>")}),o+="</ul></div>"}),H=d3.tip().direction("e").attr("class","d3-minorTip").offset(function(t,e){var a=t.length,r=d3.select("#modal-content-"+a).style("width"),i=r.substring(0,r.length-2),n=this.getBBox().x,s=this.getBBox().width,o=n+s,l=i-o;return[0,l-30]}).html(function(t,e){var a=t.length,i=r.qmatrices[a-r.K_min].color_perm,o='<div class="text-center"><strong>'+n[e]+"</strong><br>"+s[e]+" samples</div><br>";o+="<div><ul>";for(var l=[],d=0;a>d;d++)l.push({datum:t[d],color:b[i[d]]});return l.sort(function(t,e){return t.datum>e.datum?-1:t.datum==e.datum?0:1}),l.forEach(function(t,e){var a=Math.round(1e3*t.datum)/10,r=t.color;a>=.5&&(o+='<i class="fa fa-circle" style="color: '+r+' "></i>',o+="&nbsp;<strong> "+a+"%</strong></li><br>")}),o+="</ul></div>"});$(document).on("click","#downloadPDF",function(){W("no").print()}),$(document).on("click",".downloadModalPDF",function(){K=$(this)[0].id,W(K).print()});var V=function(t){var e=d3.select("#modal_body_"+t).append("div").attr("class","modal-body");e.append("div").attr("class","row").append("div").attr("class","text-center").append("button").attr("type","submit").attr("class","btn btn-default downloadModalPDF").attr("id",t).text("Print all modes at K="+t)},T=function(t,e,a,r,i){if("no"==r)var n=d3.select("body").append("div").attr("class","pbDiv"),s=a.major_mode_runid+"_print";if("yes"==r)var n=d3.select("#modal_body_"+e).append("div").attr("class","pbDiv"),s=t[0][0].getAttribute("id").slice(4)+"_print",o=t[0][0].getAttribute("id").slice(4).slice(0,t[0][0].getAttribute("id").slice(4).indexOf("_minor")),l=Object.keys(a.modes),d=L(a,l),c=d.indexOf(o);var p=n.append("a").attr("id",s).append("span").attr("class","glyphicon glyphicon-print");"no"==r&&p.attr("id","print-major-"+e),"yes"==r&&p.attr("id","print-minor-"+o),"no"==r&&(p.attr("title","Print K="+e+" barplot"),n.style("position","absolute").style("top",1.131*u*(e-i+1)+85+"px").style("left","48px")),"yes"==r&&(p.attr("title","Print "+o+" barplot"),n.style("position","absolute").style("left","48px"),0==c?n.style("top",.95*u*-1+108.8-15+"px"):n.style("top",(.95*u+5)*c+5-30+"px"))},E=function(e,a,r,i){var n=d3.select("#plot"+i).node();if("no"==a)var s=d3.select(".majorPopLabels").node();if("yes"==a){var o=n.getAttribute("class").slice(n.getAttribute("class").indexOf("-")+1);s=d3.select(".minorPopLabels_"+o).node();var l=s.getAttribute("height"),d=s.getAttribute("width"),c=N("minor_"+o+"_pop","minorPopLabels_"+o);s.setAttribute("height",c[0]),s.setAttribute("width",c[1])}var p=document.createElement("canvas"),m=t(n,p),u=t(s,p),f=window.open();return"yes"==a&&(s.setAttribute("height",l),s.setAttribute("width",d)),f.document.body.appendChild(m),f.document.body.appendChild(u),f},W=function(e){var a=document.createElement("canvas");if("no"==e)var r=document.getElementsByClassName("majorSVG"),i=d3.select(".majorPopLabels").node();else{var r=document.getElementsByClassName("minorSVG-"+e),i=d3.select(".minorPopLabels_"+e).node(),n=i.getAttribute("height"),s=i.getAttribute("width"),o=N("minor_"+e+"_pop","minorPopLabels_"+e);i.setAttribute("height",o[0]),i.setAttribute("width",o[1])}new Object;w=window.open();for(var l=0;l<r.length;l++){var d=t(r[l],a);w.document.body.appendChild(d)}return labs=t(i,a),w.document.body.appendChild(labs),"no"!=e&&(i.setAttribute("height",n),i.setAttribute("width",s)),w}});