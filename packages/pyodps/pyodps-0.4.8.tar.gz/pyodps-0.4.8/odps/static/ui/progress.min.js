Date.prototype.format=function(a){var b={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),"S":this.getMilliseconds()};if(/(y+)/.test(a))a=a.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length));for(var c in b)if(new RegExp("("+c+")").test(a))a=a.replace(RegExp.$1,(RegExp.$1.length==1)?b[c]:(("00"+b[c]).substr((""+b[c]).length)));return a;};require(["nbextensions/widgets/widgets/js/widget","nbextensions/widgets/widgets/js/manager","jquery"],function(a,b,c){var d='<div class="modal fade" id="pyodps-progress-viewer" role="dialog">'+'  <div class="modal-dialog modal-sm">'+'    <div class="modal-content">'+'      <div class="modal-header">'+'        <button type="button" class="close pull-right" data-dismiss="modal">&times;</button>'+'        <span class="generated-time pull-right"></span>'+'        <h4 class="modal-title">Modal Header</h4>'+'      </div>'+'      <div class="modal-body">'+'        <div class="instances-holder"></div>'+'      </div>'+'      <div class="modal-footer">'+'        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>'+'      </div>'+'    </div>'+'  </div>'+'</div>';var e='<div class="panel-group">'+'  <div class="panel panel-default">'+'    <div class="panel-heading">'+'      <h4 class="panel-title">'+'        <a class="instance_id" data-toggle="collapse" href="#inst_panel_{INSTANCE_ID}"></a> &nbsp; '+'      </h4>'+'    </div>'+'    <div id="inst_panel_{INSTANCE_ID}" class="panel-collapse in">'+'      <ul class="list-group tasks">'+'      </ul>'+'      <div class="panel-footer"><a class="logview" href="javascript: void(0)">Logview</a></div>'+'    </div>'+'  </div>'+'</div>';var f='<li class="list-group-item">'+'  <div class="task-name"></div>'+'  <div class="stages"></div>'+'</li>';var g='<div class="stage">'+'  <div class="stage-name"></div>'+'  <div class="stage-progress">'+'    <div class="progress">'+'      <div class="terminated progress-bar progress-bar-success" role="progressbar"></div>'+'      <div class="running progress-bar progress-bar-success" role="progressbar"></div>'+'    </div>'+'  </div>'+'</div>';var h;var i=a.DOMWidgetView.extend({initialize:function(a){var b=this;h=c('#pyodps-progress-viewer');if(h.length==0){h=c(d);c('body').append(h);}b.groupMsgs={};b.groupOrder=[];b.listenTo(b.model,'msg:custom',b._handle_route_msg,b);},render:function(){var a=this;a.textElement=c('<span style="padding-right: 5px"></span>');a.groupsElement=c('<span></span>');var b=c('<div></div>').append(a.textElement).append(a.groupsElement);a.setElement(b);},update:function(a){var b=this;if(a===undefined||a.updated_view!=b){b.textElement.text(b.model.get('text'));b._build_link();}return i.__super__.update.apply(b);},_build_link:function(){var a=this;a.groupsElement.empty();c.each(a.groupOrder,function(b,d){var e=c('<a class="pyodps-progress-launcher" href="javascript: void(0)"></a>').data('group',d).text(a.groupMsgs[d].name);e.click(function(b){var d=this;var e=c(d).data('group');a._build_modal(e);a._show_modal();b.stopPropagation();});a.groupsElement.append(e);});},_build_modal:function(a){var b=this;var d=b.groupMsgs[a];h.data('group_key',a);c('.modal-title',h).text('Progress of "'+d.name+'"');c('.generated-time',h).text('Generate time: '+new Date(d.gen_time).format('yyyy-MM-dd hh:mm:ss'));var i=c('.instances-holder',h);i.empty();if(!d.instances)return;c.each(d.instances,function(a,b){var d=c(e.replace(/\{INSTANCE_ID\}/g,b.id));var h=c('.tasks',d);c('.instance_id',d).text('Instance '+a+': '+b.status);c('.logview',d).attr('href',b.logview).attr('target','_blank');if(!b.tasks)return;c.each(b.tasks,function(a,b){var d=c(f);c('.task-name',d).text(b.name+': '+b.status);var e=c('.stages',d);if(!b.stages)e.text('No stage information available.');else c.each(b.stages,function(a,b){var d=c(g);c('.stage-name',d).text(b.name);if(b.total_workers==0)b.total_workers=1;var f=(b.terminated_workers*100/b.total_workers).toFixed(2)+'%';c('.terminated',d).width(f).text(f);var h=(b.running_workers*100/b.total_workers).toFixed(2)+'%';c('.running',d).width(h).text(h);e.append(d);});h.append(d);});i.append(d);});},_show_modal:function(){h.modal();},_handle_route_msg:function(a){var b=this;if(a){var d=c.parseJSON(a);var e=d.action;var f=[];if(d.content)f=d.content;if(e=='update'){c.each(f,function(a,d){d=c.parseJSON(d);if(!b.groupMsgs[d.key])b.groupOrder.push(d.key);b.groupMsgs[d.key]=d;if(h.data('group_key')==d.key)b._build_modal(d.key);});}else if(d.action=='delete'){c.each(f,function(a,c){if(!b.groupMsgs[c])return;delete b.groupMsgs[c];var d=b.groupOrder.indexOf(c);if(d>=0)b.groupOrder.splice(d,1);});}else if(d.action=='clear'){b.groupMsgs={};b.groupOrder=[];}}b.update();}});b.WidgetManager.register_widget_view('InstancesProgress',i);if('undefined'!==typeof pyodps&&pyodps.loaded)pyodps.loaded();});