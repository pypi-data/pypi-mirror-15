<!DOCTYPE html>
<html>
    <head>

        <meta charset="utf-8" />
		<title>$title</title>

 <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.11/css/jquery.dataTables.min.css">
 <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/rangeslider.js/2.1.1/rangeslider.min.css">

 <script src="http://cdn.plot.ly/plotly-latest.min.js"></script>
 <script src="https://code.jquery.com/jquery-1.12.0.min.js"></script>

 <script src="https://cdn.datatables.net/1.10.11/js/jquery.dataTables.min.js"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/rangeslider.js/2.1.1/rangeslider.min.js"></script>
 <script src="https://cdn.datatables.net/select/1.1.2/js/dataTables.select.min.js"></script>

 <style>
.container {
    display: inline-flex;
}

#pedplot {
}
#hetplot {
}


.rangeslider,
input[type='range'] {
  max-width: 300px;
  max-height: 300px;
}

.rangeslider--vertical {
  min-height: 220px;
}

.vertical-text {
	transform: rotate(90deg);
	transform-origin: left top 0;
}

.rangeslider__handle {
  border-radius: 12px;
  min-width: 42px;
  line-height: 38px;
  text-align: center;

  &:after {
    background: 0;
  }
}

.rangeslider__fill {
  background: #3182bd;
  position: absolute;
  height: 250px;
}

.dataTables_filter {
	    display: none;
}
body {
  color: #404040;
  display: flex;
  flex-direction: column;
  justify-content: space-around;
  align-items: center;
  padding: 20px;
}



 </style>
    </head>

<body>
<div id="link"></div>
<div class="container">
<div id="sexplot"> </div>
<div id="hetplot"> </div>
</div>

<div>
Redraw points with table selection: <input type="checkbox" id="redraw" checked /><br/>
</div>

<div class="container">
<table id="pedigree" width="44%" class="stripe row-border" cellspacing="0"></table>


<div id="pedplot"> </div>
</div>

<span style="padding:10px">
filter by <b>deviation from</b> expected <b>relatedness</b>
</span>
<input id="relslider" type="range" min="0.00" max="1" step="0.01" value="0">
<br/>

<span style="padding:10px">
filter by <b>deviation from</b> expected <b>IBS0</b>
<input id="ibscheck" type="checkbox">
</span>

</body>
<script>
function getParameterByName(name, url) {
    if (!url) url = window.location.href;
    url = url.toLowerCase(); // This is just to avoid case sensitiveness  
    name = name.replace(/[\[\]]/g, "\\$$&").toLowerCase();// This is just to avoid case sensitiveness for query parameter name
    var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$$)"),
        results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, " "));
}

var datas = {'sex': null, 'het': null, 'ped': null}

var sex_data = $sex_check

//marker:{sizemode: 'area', sizeref: 0, size:[]
var sex_good = {name: "OK", x:[], y:[], text: [], sample: [], mode:'markers', type:'scatter',
			    marker:{color:'#4daf4a', sizemode: 'area', sizeref: 0, size:[], opacity: []}}

var sex_bad = {name: "ERROR", x:[], y:[], text: [], sample: [], mode:'markers', type:'scatter',
              marker:{color: '#e41a1c', sizemode: 'area', sizeref: 0, size:[], opacity: []}}

var mean_size = 0;
var max_seen = 0;

for(i=0; v=sex_data[i], i<sex_data.length; i++){
    var a = v['error'] ? sex_bad : sex_good;
    mean_size += v['hom_ref_count'];

	max_seen = Math.max(max_seen, v['hom_ref_count'])
    

    a['x'].push(v['ped_sex'] == 'male' ? 1 : 0)
    a['y'].push(v['het_ratio'].toPrecision(3))
    a['text'].push("sample: <b>" + v['sample_id'] + "</b>")
    a['marker']['size'].push(v['hom_ref_count'])
	a['marker']['opacity'].push(1)
    a['sample'].push(v['sample_id'])
}


// make sure the smallest point isn't too small.
for(i=0; i<sex_bad['marker']['size'].length; i++){
	sex_bad['marker']['size'][i] += (max_seen / 10);
}
for(i=0; i<sex_good['marker']['size'].length; i++){
	sex_good['marker']['size'][i] += (max_seen / 10);
}

mean_size /= sex_data.length
mean_size /= 140;

sex_good['marker']['sizeref'] = mean_size;
sex_bad['marker']['sizeref'] = mean_size;

var sex_layout = {
  height: 300,
  width: '50%',
  xaxis: {
    title: 'Sex From Ped',
    titlefont: {size: 16},
    fixedrange: true,
    tickvals: [0, 1],
    ticktext: ["female", "male"],
    showline: false,
    tickfont: {size: 8},
    domain: 0.6,
    zeroline: false,
  },
  yaxis: {
    title: 'HET / HOM_ALT',
    titlefont: {size: 16},
    showline: false,
    tickfont: {size: 8},
  },
  margin: {
    t: 2
  },
  hovermode: 'closest'
};


datas['sex'] = [sex_good, sex_bad];
Plotly.plot('sexplot', datas['sex'], sex_layout);


</script>
<script>

var het_data = $het_check

var mean_size = 0;

var het_good = {name: "OK", x:[], y:[], text: [], sample: [], mode:'markers', type:'scatter',
			    marker:{color:'#4daf4a', sizemode: 'area', sizeref: 0, size:[], opacity:[]}}
var het_range = {name: "range-outlier", x:[], y:[], text: [], sample: [], mode:'markers', type:'scatter',
			    marker:{color:'#377eb8', sizemode: 'area', sizeref: 0, size:[], opacity:[]}}
var het_ratio = {name: "ratio-outlier", x:[], y:[], text: [], sample: [], mode:'markers', type:'scatter',
			    marker:{color:'#e41a1c', sizemode: 'area', sizeref: 0, size:[], opacity:[]}}

for(i=0; v=het_data[i], i<het_data.length; i++){
    var a = v['range_outlier'] ? het_range : v['ratio_outlier'] ? het_ratio : het_good;
    mean_size += v['mean_depth'];

	a['x'].push(v['range'].toPrecision(3))
    a['y'].push(v['het_ratio'].toPrecision(3))
    a['text'].push("sample: <b>" + v['sample_id'] + "</b> mean depth:" + v['mean_depth'].toFixed(1))
    a['marker']['size'].push(10 + v['mean_depth'])
    a['marker']['opacity'].push(1)
	a['sample'].push(v['sample_id'])
}

mean_size /= het_data.length;

het_good['marker']['sizeref'] = mean_size / 140;
het_range['marker']['sizeref'] = mean_size / 140;
het_ratio['marker']['sizeref'] = mean_size / 140;

var het_layout = {
  height: 300,
  width: '50%',
  xaxis: {
    title: 'MAF Range',
    titlefont: {size: 16},
    fixedrange: true,
    showline: false,
    tickfont: {size: 8},
    zeroline: false,
  },
  yaxis: {
    title: 'Proportion of HET calls',
    titlefont: {size: 16},
    showline: false,
    tickfont: {size: 8},
  },
  margin: {
    t: 2
  },
  hovermode: 'closest'
};

datas['het'] = [het_good, het_range, het_ratio]
Plotly.plot('hetplot', datas['het'], het_layout);

hetplot = document.getElementById('hetplot')
hetplot.on('plotly_hover', function(data) {
	var p = data.points[0]
	var i = p.pointNumber;
	var sample = p.data.sample[i];
	Plotly.Fx.hover('sexplot', get_points('sex', sample, ['sample']))
	Plotly.Fx.hover('pedplot', get_points('ped', sample, ['sample_a', 'sample_b']))
})
hetplot.on('plotly_unhover', function(data) {
		Plotly.Fx.unhover('sexplot');
		Plotly.Fx.unhover('pedplot');
	    table.rows({selected:true}).deselect()
})

function get_points(group, samples, keys) {
	var points = []
	if(typeof samples === 'string'){
		samples = [samples];
	}
	for(var i=0; i <samples.length;i++){
		var sample_id=samples[i];
		for (curveNumber = 0; curveNumber < datas[group].length; curveNumber++){
			if(group == 'ped' && curveNumber == 0){ continue}
			var d = datas[group][curveNumber];
			var key, v;
			for(var k=0; k<keys.length, key=keys[k]; k++){
				for(var n=0; n < d[key].length, v=d[key][n]; n++){
					if(v == sample_id) {
						points.push({curveNumber: curveNumber, pointNumber: n}) // n or i here?
					}
				}
			}
		}
	}
	return points
}

sexplot = document.getElementById('sexplot')
sexplot.on('plotly_hover', function(data) {
	var p = data.points[0]
	var i = p.pointNumber;
	var sample = p.data.sample[i];
	Plotly.Fx.hover('hetplot', get_points('het', sample, ['sample']))
	Plotly.Fx.hover('pedplot', get_points('ped', sample, ['sample_a', 'sample_b']))
})
sexplot.on('plotly_unhover', function(data) {
		Plotly.Fx.unhover('hetplot');
		Plotly.Fx.unhover('pedplot');
		table.rows({selected:true}).deselect()

})


</script>

<script>
var ped_data = $ped_check
var ped_layout = {
  height: 550,
  width: '50%',
  xaxis: {
    title: 'coefficient of relatedness',
    titlefont: {size: 16},
    fixedrange: true,
    showline: false,
    tickfont: {size: 8},
  },
  yaxis: {
    title: 'IBS0',
    titlefont: {size: 16},
    showline: false,
    tickfont: {size: 8},
  },
  margin: {
    t: 20
  },
  hovermode: 'closest'
};

var peds = {}
function get_rel_key(r, idx, parentIndex){
   val = r[idx].toPrecision(3)
   // differentiate sib-sib from parent-kid
   if(val == (0.5).toPrecision(3)){
       return val + (r[parentIndex] ? " (parent-child)" : " (sib-sib)")
   }
   return val
}
datas['ped'] = []


var column_lookup = ped_data['columns'];
var prIndex = column_lookup.indexOf('pedigree_relatedness')
if(prIndex == -1){
	alert("pedigree_relatedness not found in ped data");
}
var relIndex = column_lookup.indexOf('rel');
var pedRelIndex = column_lookup.indexOf('pedigree_relatedness');
var parentIndex = column_lookup.indexOf('pedigree_parents')
var nIndex = column_lookup.indexOf('n');
var ibs0Index = column_lookup.indexOf('ibs0');
var sampleAIndex = column_lookup.indexOf('sample_a');
var sampleBIndex = column_lookup.indexOf('sample_b');

var CUTOFF = 5000
var skip0 = ped_data['data'].length > CUTOFF && getParameterByName('all') != "true"
if (ped_data['data'].length > CUTOFF){
	jQuery('#link').wrap(function(){
		var link = jQuery('<a/>')
		var base = window.location.protocol + "//" + window.location.hostname + window.location.pathname
		if (skip0){
			base += "?all=true"
			link.text("This dataset has a lot of points. Pairs that are unrelated by their relationship in the ped file and their genotypes are not shown. Click this to show all.")
		} else {
			link.text("This dataset has a lot of points. Click this to show only points that are likely to be interesting.")
        }	
		link.attr('href', base);
		return link;
	})
}

for(var i=0; i < ped_data['data'].length, p=ped_data['data'][i]; i++){

	if (skip0 && p[pedRelIndex] == 0 && (p[relIndex] < -0.15 || Math.abs(p[relIndex]  - p[pedRelIndex]) < 0.15)){
		continue;
	}
	var k = get_rel_key(p, prIndex, parentIndex);

	if(peds[k] === undefined) {
		peds[k] = {name: k, x:[], y:[], parent: [], text: [], sample_a: [], sample_b: [], mode:'markers', type:'scatter',
		           marker: {size: [], sizemode: "area", sizeref: 23556/($each * 100), opacity:[]}, hoverinfo: "text"}
		// differentiate between parent-kid and sib-sib and use open for <= 0 relatedness
        if(k.indexOf("sib") > -1){
            peds[k]["marker"]["symbol"] = "triangle-left"
        } else if (k.indexOf("parent") > -1){
            peds[k]["marker"]["symbol"] = "square"
        } else if (parseFloat(k) <= 0) {
            peds[k]["marker"]["symbol"] = "circle-open"
        }

		datas['ped'].push(peds[k]);

	}
	peds[k]['x'].push(p[relIndex].toPrecision(3))
    peds[k]['y'].push(p[ibs0Index].toPrecision(3))
	peds[k]['sample_a'].push(p[sampleAIndex])
	peds[k]['parent'].push(p[parentIndex])
	peds[k]['marker']['size'].push(250+p[nIndex])
	peds[k]['marker']['opacity'].push(1)
	peds[k]['sample_b'].push(p[sampleBIndex])
	peds[k]['text'].push("<b>" + p[sampleAIndex] + "</b>::<b>" + p[sampleBIndex] + "</b>")

}

Plotly.plot('pedplot', datas['ped'], ped_layout);


</script>
<script>
var pedigree = $pedigree

// some gymnastics to print in order of usual ped.
var keys = ['family_id', 'sample_id', 'paternal_id', 'maternal_id', 'sex', 'phenotype']
var columns = [];
var found = {}
for(k=0; k<keys.length; k++){ 
	found[keys[k]] = true 
	columns.push({title: keys[k]})
}
for(k in pedigree[0]) {
	if(found[k] === undefined) {
		columns.push({title: k})
		keys.push(k)
	}
}
dataSet = [];
for (var i=0;i<pedigree.length, row=pedigree[i]; i++){
	var v = [];
	for (k=0; k<keys.length;k++) { v.push(row[keys[k]]) }
	dataSet.push(v)
}
var table;
jQuery(document).ready(function(){

        elrel = jQuery('#relslider')
        elibs = jQuery('#ibscheck')
        relslider = elrel.rangeslider({
            polyfill:false,
            onInit: function() {
                jQuery('.rangeslider__handle')[0].innerHTML = this.value;
            },
        })
        relslider.on('input', function(){
            jQuery('.rangeslider__handle')[0].innerHTML = this.value;
			ibsrelfilter(parseFloat(elrel.val()), elibs.prop('checked'))
        }) 


		elibs.on('change', function(){
			ibsrelfilter(parseFloat(elrel.val()), elibs.prop('checked'))
        }) 



        var cols = ""
        for(i=0;i<columns.length;i++){
			cols += "<th><input size='" + (columns[i].title.length - 1) + " type='text' placeholder='" + columns[i].title + "' /></th>"

        }
        jQuery("#pedigree").append('<tfoot><tr>' + cols  + '</tr></tfoot>');

		table = jQuery('#pedigree').DataTable({
			data: dataSet,
			columns: columns,
			paging: false,
			scrollY: "400px",
			scrollX: "700px",
			scrollCollapse: true,
			select: {style: 'os'},
		})
		// https://datatables.net/reference/event/select
		table.on('select', function(e, dt, type, indexes){
			var sample_ids = table.rows({selected: true}).data().pluck(1)
			Plotly.Fx.hover('hetplot', get_points('het', sample_ids, ['sample']))
			Plotly.Fx.hover('sexplot', get_points('sex', sample_ids, ['sample']))
			Plotly.Fx.hover('pedplot', get_points('ped', sample_ids, ['sample_a', 'sample_b']))
		})
		table.on('deselect', function(e, dt, type, indexes){
				Plotly.Fx.unhover('hetplot')
				Plotly.Fx.unhover('sexplot')
				Plotly.Fx.unhover('pedplot')
		})
        table.columns().every(function() {
            var that = this;
            jQuery('input', this.footer()).on('keyup change', function() {
                if (that.search() !== this.value ){
                    that.search(this.value, true, true).draw();
                }

				if(jQuery('#redraw').prop('checked')){
					redraw()
			 	}
            })
        })
})

function ibsrelfilter(rel, check_ibs0) {
    var expected_rels = [];
    var d = pedplot.data
    var samples = {};
    for(var i=0;i<d.length;i++){
        expected_rel = parseFloat(d[i].name)
        for(var j=0;j<d[i]['x'].length;j++){
            var obs_rel = d[i]['x'][j];
            if(Math.abs(obs_rel - expected_rel) <= rel) {
                d[i]['marker']['opacity'][j] = 0.02;
                continue
            }
            // now check ibs0;
            var obs_ibs = d[i]['y'][j];
            var is_parent = d[i]['parent'][j]
            if(check_ibs0 && ((obs_ibs > 0.01) != is_parent)){
                d[i]['marker']['opacity'][j] = 0.02;
                continue
            }
            samples[d[i]['sample_a'][j]] = true;
            samples[d[i]['sample_b'][j]] = true;
            d[i]['marker']['opacity'][j] = 1;

        }

    } 

	// hack to apply the search.
    jQuery.fn.dataTable.ext.search.push(function(settings, data, dataIndex){
            return samples[data[1]] != undefined;
    });
    table.draw();
	// the search is applied to the table, now just use redraw machinery to update the other plots.
    jQuery.fn.dataTable.ext.search.pop();
    redraw();
}


function redraw(all) {
	// these are the samples that are visible in the table.
	var samples
	if(all == undefined){
       samples = table.rows({filter:"applied"}).data().pluck(1)
	} else {
       samples = table.rows().data().pluck(1)
	}
	var so = {}
	for(var i=0;i<samples.length;i++){so[samples[i]] = true;}

	for(var k=0; k<sexplot.data.length;k++){
		for(i=0;i<sexplot.data[k]['sample'].length; i++){
			var s=sexplot.data[k]['sample'][i];
			if(so[s]){
				sexplot.data[k]['marker']['opacity'][i] = 1;
			} else {
				sexplot.data[k]['marker']['opacity'][i] = 0.04;
			}
		}
	}
	Plotly.redraw(sexplot)

	for(var k=0; k<hetplot.data.length;k++){
		for(i=0;i<hetplot.data[k]['sample'].length; i++){
			var s=hetplot.data[k]['sample'][i];
			if(so[s]){
				hetplot.data[k]['marker']['opacity'][i] = 1;
			} else {
				hetplot.data[k]['marker']['opacity'][i] = 0.04;
			}
		}
	}
	Plotly.redraw(hetplot)

    for(var k=0; k<pedplot.data.length;k++){
        var n = Math.max(pedplot.data[k]['sample_a'].length,
                         pedplot.data[k]['sample_b'].length)

        for(i=0; i<n; i++){
            var sa = pedplot.data[k]['sample_a'][i];
            var sb = pedplot.data[k]['sample_b'][i];
            if(so[sa] || so[sb]){
                pedplot.data[k]['marker']['opacity'][i] = 1;
            } else {
                pedplot.data[k]['marker']['opacity'][i] = 0.04;
            }
        }
    }
    Plotly.redraw(pedplot)

}

</script>

</html>
