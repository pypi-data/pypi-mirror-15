

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Custom Plugins &mdash; django cms 3.3.0.dev4 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="django cms 3.3.0.dev4 documentation" href="../index.html"/>
        <link rel="up" title="How-to guides" href="index.html"/>
        <link rel="next" title="Customising navigation menus" href="menus.html"/>
        <link rel="prev" title="Installing django CMS by hand" href="install.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> django cms
          

          
          </a>

          
            
            
              <div class="version">
                3.3.0.dev4
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../introduction/index.html">Tutorials</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">How-to guides</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="install.html">Installing django CMS by hand</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="">Custom Plugins</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#why-would-you-need-to-write-a-plugin">Why would you need to write a plugin?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#overview">Overview</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#a-note-about-cms-plugin-base-cmspluginbase">A note about <code class="docutils literal"><span class="pre">cms.plugin_base.CMSPluginBase</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#an-aside-on-models-and-configuration">An aside on models and configuration</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#the-simplest-plugin">The simplest plugin</a></li>
<li class="toctree-l3"><a class="reference internal" href="#troubleshooting">Troubleshooting</a></li>
<li class="toctree-l3"><a class="reference internal" href="#storing-configuration">Storing configuration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#handling-relations">Handling Relations</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#advanced">Advanced</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#inline-admin">Inline Admin</a></li>
<li class="toctree-l4"><a class="reference internal" href="#plugin-form">Plugin form</a></li>
<li class="toctree-l4"><a class="reference internal" href="#handling-media">Handling media</a></li>
<li class="toctree-l4"><a class="reference internal" href="#plugin-context">Plugin Context</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id4">Plugin Context Processors</a></li>
<li class="toctree-l4"><a class="reference internal" href="#plugin-processors">Plugin Processors</a></li>
<li class="toctree-l4"><a class="reference internal" href="#nested-plugins">Nested Plugins</a></li>
<li class="toctree-l4"><a class="reference internal" href="#extending-context-menus-of-placeholders-or-plugins">Extending context menus of placeholders or plugins</a></li>
<li class="toctree-l4"><a class="reference internal" href="#plugin-data-migrations">Plugin data migrations</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="menus.html">Customising navigation menus</a></li>
<li class="toctree-l2"><a class="reference internal" href="apphooks.html">Apphooks</a></li>
<li class="toctree-l2"><a class="reference internal" href="templates.html">Working with templates</a></li>
<li class="toctree-l2"><a class="reference internal" href="extending_page_title.html">Extending the page &amp; title models</a></li>
<li class="toctree-l2"><a class="reference internal" href="toolbar.html">Extending the Toolbar</a></li>
<li class="toctree-l2"><a class="reference internal" href="testing.html">Testing Your Extensions</a></li>
<li class="toctree-l2"><a class="reference internal" href="placeholders.html">Placeholders outside the CMS</a></li>
<li class="toctree-l2"><a class="reference internal" href="caching.html">Caching</a></li>
<li class="toctree-l2"><a class="reference internal" href="frontend_models.html">Frontend editing for Page and Django models</a></li>
<li class="toctree-l2"><a class="reference internal" href="sitemap.html">Sitemap Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="page_types.html">Page Types</a></li>
<li class="toctree-l2"><a class="reference internal" href="wizards.html">Content creation wizards</a></li>
<li class="toctree-l2"><a class="reference internal" href="contributing.html">Contributing a patch</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../topics/index.html">Key topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/index.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing/index.html">Development &amp; community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../upgrade/index.html">Release notes &amp; upgrade information</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/index.html">Using django CMS</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">django cms</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="index.html">How-to guides</a> &raquo;</li>
      
    <li>Custom Plugins</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/how_to/custom_plugins.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="custom-plugins">
<span id="id1"></span><h1>Custom Plugins<a class="headerlink" href="#custom-plugins" title="Permalink to this headline">¶</a></h1>
<p>CMS Plugins are reusable content publishers that can be inserted into django
CMS pages (or indeed into any content that uses django CMS placeholders). They
enable the publishing of information automatically, without further
intervention.</p>
<p>This means that your published web content, whatever it is, is kept
up-to-date at all times.</p>
<p>It&#8217;s like magic, but quicker.</p>
<p>Unless you&#8217;re lucky enough to discover that your needs can be met by the
built-in plugins, or by the many available third-party plugins, you&#8217;ll have to
write your own custom CMS Plugin. Don&#8217;t worry though - writing a CMS Plugin is
rather simple.</p>
<div class="section" id="why-would-you-need-to-write-a-plugin">
<h2>Why would you need to write a plugin?<a class="headerlink" href="#why-would-you-need-to-write-a-plugin" title="Permalink to this headline">¶</a></h2>
<p>A plugin is the most convenient way to integrate content from another Django
app into a django CMS page.</p>
<p>For example, suppose you&#8217;re developing a site for a record company in django
CMS. You might like to have a &#8220;Latest releases&#8221; box on your site&#8217;s home page.</p>
<p>Of course, you could every so often edit that page and update the information.
However, a sensible record company will manage its catalogue in Django too,
which means Django already knows what this week&#8217;s new releases are.</p>
<p>This is an excellent opportunity to make use of that information to make your
life easier - all you need to do is create a django CMS plugin that you can
insert into your home page, and leave it to do the work of publishing information
about the latest releases for you.</p>
<p>Plugins are <strong>reusable</strong>. Perhaps your record company is producing a series of
reissues of seminal Swiss punk records; on your site&#8217;s page about the series,
you could insert the same plugin, configured a little differently, that will
publish information about recent new releases in that series.</p>
</div>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>A django CMS plugin is fundamentally composed of three things.</p>
<ul class="simple">
<li>a plugin <strong>editor</strong>, to configure a plugin each time it is deployed</li>
<li>a plugin <strong>publisher</strong>, to do the automated work of deciding what to publish</li>
<li>a plugin <strong>template</strong>, to render the information into a web page</li>
</ul>
<p>These correspond to the familiar Model-View-Template scheme:</p>
<ul class="simple">
<li>the plugin <strong>model</strong> to store its configuration</li>
<li>the plugin <strong>view</strong> that works out what needs to be displayed</li>
<li>the plugin <strong>template</strong> to render the information</li>
</ul>
<p>And so to build your plugin, you&#8217;ll make it from:</p>
<ul class="simple">
<li>a sub-class of <code class="xref py py-class docutils literal"><span class="pre">cms.models.pluginmodel.CMSPlugin</span></code> to
<strong>store the configuration</strong> for your plugin instances</li>
<li>a sub-class of <a class="reference internal" href="../reference/api_references.html#cms.plugin_base.CMSPluginBase" title="cms.plugin_base.CMSPluginBase"><code class="xref py py-class docutils literal"><span class="pre">cms.plugin_base.CMSPluginBase</span></code></a> that <strong>defines
the operating logic</strong> of your plugin</li>
<li>a template that <strong>renders your plugin</strong></li>
</ul>
<div class="section" id="a-note-about-cms-plugin-base-cmspluginbase">
<h3>A note about <a class="reference internal" href="../reference/api_references.html#cms.plugin_base.CMSPluginBase" title="cms.plugin_base.CMSPluginBase"><code class="xref py py-class docutils literal"><span class="pre">cms.plugin_base.CMSPluginBase</span></code></a><a class="headerlink" href="#a-note-about-cms-plugin-base-cmspluginbase" title="Permalink to this headline">¶</a></h3>
<p><a class="reference internal" href="../reference/api_references.html#cms.plugin_base.CMSPluginBase" title="cms.plugin_base.CMSPluginBase"><code class="xref py py-class docutils literal"><span class="pre">cms.plugin_base.CMSPluginBase</span></code></a> is actually a sub-class of
<code class="xref py py-class docutils literal"><span class="pre">django.contrib.admin.options.ModelAdmin</span></code>.</p>
<p>Because <code class="xref py py-class docutils literal"><span class="pre">CMSPluginBase</span></code> sub-classes <code class="docutils literal"><span class="pre">ModelAdmin</span></code> several important
<code class="docutils literal"><span class="pre">ModelAdmin</span></code> options are also available to CMS plugin developers. These
options are often used:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">exclude</span></code></li>
<li><code class="docutils literal"><span class="pre">fields</span></code></li>
<li><code class="docutils literal"><span class="pre">fieldsets</span></code></li>
<li><code class="docutils literal"><span class="pre">form</span></code></li>
<li><code class="docutils literal"><span class="pre">formfield_overrides</span></code></li>
<li><code class="docutils literal"><span class="pre">inlines</span></code></li>
<li><code class="docutils literal"><span class="pre">radio_fields</span></code></li>
<li><code class="docutils literal"><span class="pre">raw_id_fields</span></code></li>
<li><code class="docutils literal"><span class="pre">readonly_fields</span></code></li>
</ul>
<p>Please note, however, that not all <code class="docutils literal"><span class="pre">ModelAdmin</span></code> options are effective in a CMS
plugin. In particular, any options that are used exclusively by the
<code class="docutils literal"><span class="pre">ModelAdmin</span></code>&#8216;s <code class="docutils literal"><span class="pre">changelist</span></code> will have no effect. These and other notable options
that are ignored by the CMS are:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">actions</span></code></li>
<li><code class="docutils literal"><span class="pre">actions_on_top</span></code></li>
<li><code class="docutils literal"><span class="pre">actions_on_bottom</span></code></li>
<li><code class="docutils literal"><span class="pre">actions_selection_counter</span></code></li>
<li><code class="docutils literal"><span class="pre">date_hierarchy</span></code></li>
<li><code class="docutils literal"><span class="pre">list_display</span></code></li>
<li><code class="docutils literal"><span class="pre">list_display_links</span></code></li>
<li><code class="docutils literal"><span class="pre">list_editable</span></code></li>
<li><code class="docutils literal"><span class="pre">list_filter</span></code></li>
<li><code class="docutils literal"><span class="pre">list_max_show_all</span></code></li>
<li><code class="docutils literal"><span class="pre">list_per_page</span></code></li>
<li><code class="docutils literal"><span class="pre">ordering</span></code></li>
<li><code class="docutils literal"><span class="pre">paginator</span></code></li>
<li><code class="docutils literal"><span class="pre">preserve_fields</span></code></li>
<li><code class="docutils literal"><span class="pre">save_as</span></code></li>
<li><code class="docutils literal"><span class="pre">save_on_top</span></code></li>
<li><code class="docutils literal"><span class="pre">search_fields</span></code></li>
<li><code class="docutils literal"><span class="pre">show_full_result_count</span></code></li>
<li><code class="docutils literal"><span class="pre">view_on_site</span></code></li>
</ul>
</div>
<div class="section" id="an-aside-on-models-and-configuration">
<h3>An aside on models and configuration<a class="headerlink" href="#an-aside-on-models-and-configuration" title="Permalink to this headline">¶</a></h3>
<p>The plugin <strong>model</strong>, the sub-class of <code class="xref py py-class docutils literal"><span class="pre">cms.models.pluginmodel.CMSPlugin</span></code>,
is actually optional.</p>
<p>You could have a plugin that doesn&#8217;t need to be configured, because it only
ever does one thing.</p>
<p>For example, you could have a plugin that only publishes information
about the top-selling record of the past seven days. Obviously, this wouldn&#8217;t
be very flexible - you wouldn&#8217;t be able to use the same plugin for the
best-selling release of the last <em>month</em> instead.</p>
<p>Usually, you find that it is useful to be able to configure your plugin, and this
will require a model.</p>
</div>
</div>
<div class="section" id="the-simplest-plugin">
<h2>The simplest plugin<a class="headerlink" href="#the-simplest-plugin" title="Permalink to this headline">¶</a></h2>
<p>You may use <code class="docutils literal"><span class="pre">python</span> <span class="pre">manage.py</span> <span class="pre">startapp</span></code> to set up the basic layout for you
plugin app (remember to add your plugin to <code class="docutils literal"><span class="pre">INSTALLED_APPS</span></code>). Alternatively, just add a file called <code class="docutils literal"><span class="pre">cms_plugins.py</span></code> to an
existing Django application.</p>
<p>In <code class="docutils literal"><span class="pre">cms_plugins.py</span></code>, you place your plugins. For our example, include the following code:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">cms.plugin_base</span> <span class="kn">import</span> <span class="n">CMSPluginBase</span>
<span class="kn">from</span> <span class="nn">cms.plugin_pool</span> <span class="kn">import</span> <span class="n">plugin_pool</span>
<span class="kn">from</span> <span class="nn">cms.models.pluginmodel</span> <span class="kn">import</span> <span class="n">CMSPlugin</span>
<span class="kn">from</span> <span class="nn">django.utils.translation</span> <span class="kn">import</span> <span class="n">ugettext_lazy</span> <span class="k">as</span> <span class="n">_</span>

<span class="k">class</span> <span class="nc">HelloPlugin</span><span class="p">(</span><span class="n">CMSPluginBase</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">CMSPlugin</span>
    <span class="n">render_template</span> <span class="o">=</span> <span class="s">&quot;hello_plugin.html&quot;</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="bp">False</span>

<span class="n">plugin_pool</span><span class="o">.</span><span class="n">register_plugin</span><span class="p">(</span><span class="n">HelloPlugin</span><span class="p">)</span>
</pre></div>
</div>
<p>Now we&#8217;re almost done. All that&#8217;s left is to add the template. Add the
following into the root template directory in a file called
<code class="docutils literal"><span class="pre">hello_plugin.html</span></code>:</p>
<div class="highlight-html+django"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>Hello <span class="cp">{%</span> <span class="k">if</span> <span class="nv">request.user.is_authenticated</span> <span class="cp">%}{{</span> <span class="nv">request.user.first_name</span> <span class="cp">}}</span> <span class="cp">{{</span> <span class="nv">request.user.last_name</span><span class="cp">}}{%</span> <span class="k">else</span> <span class="cp">%}</span>Guest<span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="nt">&lt;/h1&gt;</span>
</pre></div>
</div>
<p>This plugin will now greet the users on your website either by their name if
they&#8217;re logged in, or as Guest if they&#8217;re not.</p>
<p>Now let&#8217;s take a closer look at what we did there. The <code class="docutils literal"><span class="pre">cms_plugins.py</span></code> files
are where you should define your sub-classes of
<a class="reference internal" href="../reference/api_references.html#cms.plugin_base.CMSPluginBase" title="cms.plugin_base.CMSPluginBase"><code class="xref py py-class docutils literal"><span class="pre">cms.plugin_base.CMSPluginBase</span></code></a>, these classes define the different
plugins.</p>
<p>There are two required attributes on those classes:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">model</span></code>: The model you wish to use for storing information about this plugin.
If you do not require any special information, for example configuration, to
be stored for your plugins, you can simply use
<code class="xref py py-class docutils literal"><span class="pre">cms.models.pluginmodel.CMSPlugin</span></code> (we&#8217;ll look at that model more
closely in a bit). In a normal admin class, you don&#8217;t need to supply this
information because <code class="docutils literal"><span class="pre">admin.site.register(Model,</span> <span class="pre">Admin)</span></code> takes care of it,
but a plugin is not registered in that way.</li>
<li><code class="docutils literal"><span class="pre">name</span></code>: The name of your plugin as displayed in the admin. It is generally
good practice to mark this string as translatable using
<a class="reference external" href="http://readthedocs.org/docs/django/en/latest/ref/utils.html#django.utils.translation.ugettext_lazy" title="(in Django v1.10)"><code class="xref py py-func docutils literal"><span class="pre">django.utils.translation.ugettext_lazy()</span></code></a>, however this is optional. By
default the name is a nicer version of the class name.</li>
</ul>
<p>And one of the following <strong>must</strong> be defined if <code class="docutils literal"><span class="pre">render_plugin</span></code> attribute
is <code class="docutils literal"><span class="pre">True</span></code> (the default):</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">render_template</span></code>: The template to render this plugin with.</li>
</ul>
<p><strong>or</strong></p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">get_render_template</span></code>: A method that returns a template path to render the
plugin with.</li>
</ul>
<p>In addition to those attributes, you can also override the <a class="reference internal" href="../reference/plugins.html#render"><span>render</span></a> method
which determines the template context variables that are used render your
plugin. By default, this method only adds <code class="docutils literal"><span class="pre">instance</span></code> and <code class="docutils literal"><span class="pre">placeholder</span></code>
objects to your context, but plugins can override this to include any context
that is required.</p>
<p>A number of other methods are available for overriding on your CMSPluginBase
sub-classes. See: <a class="reference internal" href="../reference/api_references.html#module-cms.plugin_base" title="cms.plugin_base"><code class="xref py py-mod docutils literal"><span class="pre">cms.plugin_base</span></code></a> for further details.</p>
</div>
<div class="section" id="troubleshooting">
<h2>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permalink to this headline">¶</a></h2>
<p>Since plugin modules are found and loaded by django&#8217;s importlib, you might
experience errors because the path environment is different at runtime. If
your <cite>cms_plugins</cite> isn&#8217;t loaded or accessible, try the following:</p>
<div class="highlight-python"><div class="highlight"><pre>$ python manage.py shell
&gt;&gt;&gt; from importlib import import_module
&gt;&gt;&gt; m = import_module(&quot;myapp.cms_plugins&quot;)
&gt;&gt;&gt; m.some_test_function()
</pre></div>
</div>
</div>
<div class="section" id="storing-configuration">
<span id="id2"></span><h2>Storing configuration<a class="headerlink" href="#storing-configuration" title="Permalink to this headline">¶</a></h2>
<p>In many cases, you want to store configuration for your plugin instances. For
example, if you have a plugin that shows the latest blog posts, you might want
to be able to choose the amount of entries shown. Another example would be a
gallery plugin where you want to choose the pictures to show for the plugin.</p>
<p>To do so, you create a Django model by sub-classing
<code class="xref py py-class docutils literal"><span class="pre">cms.models.pluginmodel.CMSPlugin</span></code> in the <code class="docutils literal"><span class="pre">models.py</span></code> of an installed
application.</p>
<p>Let&#8217;s improve our <code class="docutils literal"><span class="pre">HelloPlugin</span></code> from above by making its fallback name for
non-authenticated users configurable.</p>
<p>In our <code class="docutils literal"><span class="pre">models.py</span></code> we add the following:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">cms.models.pluginmodel</span> <span class="kn">import</span> <span class="n">CMSPlugin</span>

<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>

<span class="k">class</span> <span class="nc">Hello</span><span class="p">(</span><span class="n">CMSPlugin</span><span class="p">):</span>
    <span class="n">guest_name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">&#39;Guest&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>If you followed the Django tutorial, this shouldn&#8217;t look too new to you. The
only difference to normal models is that you sub-class
<code class="xref py py-class docutils literal"><span class="pre">cms.models.pluginmodel.CMSPlugin</span></code> rather than
<code class="xref py py-class docutils literal"><span class="pre">django.db.models.base.Model</span></code>.</p>
<p>Now we need to change our plugin definition to use this model, so our new
<code class="docutils literal"><span class="pre">cms_plugins.py</span></code> looks like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">cms.plugin_base</span> <span class="kn">import</span> <span class="n">CMSPluginBase</span>
<span class="kn">from</span> <span class="nn">cms.plugin_pool</span> <span class="kn">import</span> <span class="n">plugin_pool</span>
<span class="kn">from</span> <span class="nn">django.utils.translation</span> <span class="kn">import</span> <span class="n">ugettext_lazy</span> <span class="k">as</span> <span class="n">_</span>

<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Hello</span>

<span class="k">class</span> <span class="nc">HelloPlugin</span><span class="p">(</span><span class="n">CMSPluginBase</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Hello</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;Hello Plugin&quot;</span><span class="p">)</span>
    <span class="n">render_template</span> <span class="o">=</span> <span class="s">&quot;hello_plugin.html&quot;</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">placeholder</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">HelloPlugin</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">placeholder</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">context</span>

<span class="n">plugin_pool</span><span class="o">.</span><span class="n">register_plugin</span><span class="p">(</span><span class="n">HelloPlugin</span><span class="p">)</span>
</pre></div>
</div>
<p>We changed the <code class="docutils literal"><span class="pre">model</span></code> attribute to point to our newly created <code class="docutils literal"><span class="pre">Hello</span></code>
model and pass the model instance to the context.</p>
<p>As a last step, we have to update our template to make use of this
new configuration:</p>
<div class="highlight-html+django"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>Hello <span class="cp">{%</span> <span class="k">if</span> <span class="nv">request.user.is_authenticated</span> <span class="cp">%}</span>
  <span class="cp">{{</span> <span class="nv">request.user.first_name</span> <span class="cp">}}</span> <span class="cp">{{</span> <span class="nv">request.user.last_name</span><span class="cp">}}</span>
<span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span>
  <span class="cp">{{</span> <span class="nv">instance.guest_name</span> <span class="cp">}}</span>
<span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="nt">&lt;/h1&gt;</span>
</pre></div>
</div>
<p>The only thing we changed there is that we use the template variable <code class="docutils literal"><span class="pre">{{</span>
<span class="pre">instance.guest_name</span> <span class="pre">}}</span></code> instead of the hard-coded <code class="docutils literal"><span class="pre">Guest</span></code> string in the else
clause.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>You cannot name your model fields the same as any installed plugins lower-
cased model name, due to the implicit one-to-one relation Django uses for
sub-classed models. If you use all core plugins, this includes: <code class="docutils literal"><span class="pre">file</span></code>,
<code class="docutils literal"><span class="pre">googlemap</span></code>, <code class="docutils literal"><span class="pre">link</span></code>, <code class="docutils literal"><span class="pre">picture</span></code>, <code class="docutils literal"><span class="pre">snippetptr</span></code>, <code class="docutils literal"><span class="pre">teaser</span></code>,
<code class="docutils literal"><span class="pre">twittersearch</span></code>, <code class="docutils literal"><span class="pre">twitterrecententries</span></code> and <code class="docutils literal"><span class="pre">video</span></code>.</p>
<p class="last">Additionally, it is <em>recommended</em> that you avoid using <code class="docutils literal"><span class="pre">page</span></code> as a model
field, as it is declared as a property of <code class="xref py py-class docutils literal"><span class="pre">cms.models.pluginmodel.CMSPlugin</span></code>,
and your plugin will not work as intended in the administration without
further work.</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">If you are using Python 2.x and overriding the <code class="docutils literal"><span class="pre">__unicode__</span></code> method of the
model file, make sure to return its results as UTF8-string. Otherwise
saving an instance of your plugin might fail with the frontend editor showing
an &lt;Empty&gt; plugin instance. To return in Unicode use a return statement like
<code class="docutils literal"><span class="pre">return</span> <span class="pre">u'{0}'.format(self.guest_name)</span></code>.</p>
</div>
<div class="section" id="handling-relations">
<span id="id3"></span><h3>Handling Relations<a class="headerlink" href="#handling-relations" title="Permalink to this headline">¶</a></h3>
<p>Every time the page with your custom plugin is published the plugin is copied.
So if your custom plugin has foreign key (to it, or from it) or many-to-many
relations you are responsible for copying those related objects, if required,
whenever the CMS copies the plugin - <strong>it won&#8217;t do it for you automatically</strong>.</p>
<p>Every plugin model inherits the empty
<code class="xref py py-meth docutils literal"><span class="pre">cms.models.pluginmodel.CMSPlugin.copy_relations()</span></code> method from the base
class, and it&#8217;s called when your plugin is copied. So, it&#8217;s there for you to
adapt to your purposes as required.</p>
<p>Typically, you will want it to copy related objects. To do this you should
create a method called <code class="docutils literal"><span class="pre">copy_relations</span></code> on your plugin model, that receives
the <strong>old</strong> instance of the plugin as an argument.</p>
<p>You may however decide that the related objects shouldn&#8217;t be copied - you may
want to leave them alone, for example. Or, you might even want to choose some
altogether different relations for it, or to create new ones when it&#8217;s
copied... it depends on your plugin and the way you want it to work.</p>
<p>If you do want to copy related objects, you&#8217;ll need to do this in two slightly
different ways, depending on whether your plugin has relations <em>to</em> or <em>from</em>
other objects that need to be copied too:</p>
<div class="section" id="for-foreign-key-relations-from-other-objects">
<h4>For foreign key relations <em>from</em> other objects<a class="headerlink" href="#for-foreign-key-relations-from-other-objects" title="Permalink to this headline">¶</a></h4>
<p>Your plugin may have items with foreign keys to it, which will typically be
the case if you set it up so that they are inlines in its admin. So you might
have two models, one for the plugin and one for those items:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ArticlePluginModel</span><span class="p">(</span><span class="n">CMSPlugin</span><span class="p">):</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">AssociatedItem</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">plugin</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
        <span class="n">ArticlePluginModel</span><span class="p">,</span>
        <span class="n">related_name</span><span class="o">=</span><span class="s">&quot;associated_item&quot;</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>You&#8217;ll then need the <code class="docutils literal"><span class="pre">copy_relations()</span></code> method on your plugin model to loop
over the associated items and copy them, giving the copies foreign keys to the
new plugin:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ArticlePluginModel</span><span class="p">(</span><span class="n">CMSPlugin</span><span class="p">):</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">copy_relations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oldinstance</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">associated_item</span> <span class="ow">in</span> <span class="n">oldinstance</span><span class="o">.</span><span class="n">associated_item</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="c"># instance.pk = None; instance.pk.save() is the slightly odd but</span>
            <span class="c"># standard Django way of copying a saved model instance</span>
            <span class="n">associated_item</span><span class="o">.</span><span class="n">pk</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">associated_item</span><span class="o">.</span><span class="n">plugin</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="n">associated_item</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="for-many-to-many-or-foreign-key-relations-to-other-objects">
<h4>For many-to-many or foreign key relations <em>to</em> other objects<a class="headerlink" href="#for-many-to-many-or-foreign-key-relations-to-other-objects" title="Permalink to this headline">¶</a></h4>
<p>Let&#8217;s assume these are the relevant bits of your plugin:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ArticlePluginModel</span><span class="p">(</span><span class="n">CMSPlugin</span><span class="p">):</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">sections</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="n">Section</span><span class="p">)</span>
</pre></div>
</div>
<p>Now when the plugin gets copied, you want to make sure the sections stay, so
it becomes:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ArticlePluginModel</span><span class="p">(</span><span class="n">CMSPlugin</span><span class="p">):</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">sections</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="n">Section</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">copy_relations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">oldinstance</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sections</span> <span class="o">=</span> <span class="n">oldinstance</span><span class="o">.</span><span class="n">sections</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</pre></div>
</div>
<p>If your plugins have relational fields of both kinds, you may of course need
to use <em>both</em> the copying techniques described above.</p>
</div>
<div class="section" id="relations-between-plugins">
<h4>Relations <em>between</em> plugins<a class="headerlink" href="#relations-between-plugins" title="Permalink to this headline">¶</a></h4>
<p>It is much harder to manage the copying of relations when they are from one plugin to another.</p>
<p>See the GitHub issue <a class="reference external" href="https://github.com/divio/django-cms/issues/4143">copy_relations() does not work for relations between cmsplugins #4143</a> for more details.</p>
</div>
</div>
</div>
<div class="section" id="advanced">
<h2>Advanced<a class="headerlink" href="#advanced" title="Permalink to this headline">¶</a></h2>
<div class="section" id="inline-admin">
<h3>Inline Admin<a class="headerlink" href="#inline-admin" title="Permalink to this headline">¶</a></h3>
<p>If you want to have the foreign key relation as a inline admin, you can create an
<code class="docutils literal"><span class="pre">admin.StackedInline</span></code> class and put it in the Plugin to &#8220;inlines&#8221;. Then you can use the inline
admin form for your foreign key references:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ItemInlineAdmin</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">StackedInline</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">AssociatedItem</span>


<span class="k">class</span> <span class="nc">ArticlePlugin</span><span class="p">(</span><span class="n">CMSPluginBase</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">ArticlePluginModel</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;Article Plugin&quot;</span><span class="p">)</span>
    <span class="n">render_template</span> <span class="o">=</span> <span class="s">&quot;article/index.html&quot;</span>
    <span class="n">inlines</span> <span class="o">=</span> <span class="p">(</span><span class="n">ItemInlineAdmin</span><span class="p">,)</span>

    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">placeholder</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">ArticlePlugin</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">placeholder</span><span class="p">)</span>
        <span class="n">items</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">associated_item</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">context</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s">&#39;items&#39;</span><span class="p">:</span> <span class="n">items</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="k">return</span> <span class="n">context</span>
</pre></div>
</div>
</div>
<div class="section" id="plugin-form">
<h3>Plugin form<a class="headerlink" href="#plugin-form" title="Permalink to this headline">¶</a></h3>
<p>Since <a class="reference internal" href="../reference/api_references.html#cms.plugin_base.CMSPluginBase" title="cms.plugin_base.CMSPluginBase"><code class="xref py py-class docutils literal"><span class="pre">cms.plugin_base.CMSPluginBase</span></code></a> extends
<code class="xref py py-class docutils literal"><span class="pre">django.contrib.admin.options.ModelAdmin</span></code>, you can customise the form
for your plugins just as you would customise your admin interfaces.</p>
<p>The template that the plugin editing mechanism uses is
<code class="docutils literal"><span class="pre">cms/templates/admin/cms/page/plugin/change_form.html</span></code>. You might need to
change this.</p>
<p>If you want to customise this the best way to do it is:</p>
<ul class="simple">
<li>create a template of your own that extends <code class="docutils literal"><span class="pre">cms/templates/admin/cms/page/plugin/change_form.html</span></code>
to provide the functionality you require;</li>
<li>provide your <a class="reference internal" href="../reference/api_references.html#cms.plugin_base.CMSPluginBase" title="cms.plugin_base.CMSPluginBase"><code class="xref py py-class docutils literal"><span class="pre">cms.plugin_base.CMSPluginBase</span></code></a> sub-class with a
<code class="docutils literal"><span class="pre">change_form_template</span></code> attribute pointing at your new template.</li>
</ul>
<p>Extending <code class="docutils literal"><span class="pre">admin/cms/page/plugin/change_form.html</span></code> ensures that you&#8217;ll keep
a unified look and functionality across your plugins.</p>
<p>There are various reasons <em>why</em> you might want to do this. For example, you
might have a snippet of JavaScript that needs to refer to a template
variable), which you&#8217;d likely place in <code class="docutils literal"><span class="pre">{%</span> <span class="pre">block</span> <span class="pre">extrahead</span> <span class="pre">%}</span></code>, after a <code class="docutils literal"><span class="pre">{{</span>
<span class="pre">block.super</span> <span class="pre">}}</span></code> to inherit the existing items that were in the parent
template.</p>
<p>Or: <code class="docutils literal"><span class="pre">cms/templates/admin/cms/page/plugin/change_form.html</span></code> extends Django&#8217;s
own <code class="docutils literal"><span class="pre">admin/base_site.html</span></code>, which loads a rather elderly version of jQuery,
and your plugin admin might require something newer. In this case, in your
custom <code class="docutils literal"><span class="pre">change_form_template</span></code> you could do something like:</p>
<div class="highlight-python"><div class="highlight"><pre>{% block jquery %}
    &lt;script type=&quot;text/javascript&quot; src=&quot;///ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;
{% endblock jquery %}``
</pre></div>
</div>
<p>to override the <code class="docutils literal"><span class="pre">{%</span> <span class="pre">block</span> <span class="pre">jquery</span> <span class="pre">%}</span></code>.</p>
</div>
<div class="section" id="handling-media">
<span id="custom-plugins-handling-media"></span><h3>Handling media<a class="headerlink" href="#handling-media" title="Permalink to this headline">¶</a></h3>
<p>If your plugin depends on certain media files, JavaScript or stylesheets, you
can include them from your plugin template using <a class="reference external" href="https://github.com/ojii/django-sekizai">django-sekizai</a>. Your CMS
templates are always enforced to have the <code class="docutils literal"><span class="pre">css</span></code> and <code class="docutils literal"><span class="pre">js</span></code> sekizai namespaces,
therefore those should be used to include the respective files. For more
information about django-sekizai, please refer to the
<a class="reference external" href="http://django-sekizai.readthedocs.org">django-sekizai documentation</a>.</p>
<p>Note that sekizai <em>can&#8217;t</em> help you with the <em>admin-side</em> plugin templates -
what follows is for your plugins&#8217; <em>output</em> templates.</p>
<div class="section" id="sekizai-style">
<h4>Sekizai style<a class="headerlink" href="#sekizai-style" title="Permalink to this headline">¶</a></h4>
<p>To fully harness the power of django-sekizai, it is helpful to have a consistent
style on how to use it. Here is a set of conventions that should be followed
(but don&#8217;t necessarily need to be):</p>
<ul class="simple">
<li>One bit per <code class="docutils literal"><span class="pre">addtoblock</span></code>. Always include one external CSS or JS file per
<code class="docutils literal"><span class="pre">addtoblock</span></code> or one snippet per <code class="docutils literal"><span class="pre">addtoblock</span></code>. This is needed so
django-sekizai properly detects duplicate files.</li>
<li>External files should be on one line, with no spaces or newlines between the
<code class="docutils literal"><span class="pre">addtoblock</span></code> tag and the HTML tags.</li>
<li>When using embedded javascript or CSS, the HTML tags should be on a newline.</li>
</ul>
<p>A <strong>good</strong> example:</p>
<div class="highlight-html+django"><div class="highlight"><pre><span class="cp">{%</span> <span class="k">load</span> <span class="nv">sekizai_tags</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">addtoblock</span> <span class="s2">&quot;js&quot;</span> <span class="cp">%}</span><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">MEDIA_URL</span> <span class="cp">}}</span><span class="s">myplugin/js/myjsfile.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span><span class="cp">{%</span> <span class="k">endaddtoblock</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">addtoblock</span> <span class="s2">&quot;js&quot;</span> <span class="cp">%}</span><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">MEDIA_URL</span> <span class="cp">}}</span><span class="s">myplugin/js/myotherfile.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span><span class="cp">{%</span> <span class="k">endaddtoblock</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">addtoblock</span> <span class="s2">&quot;css&quot;</span> <span class="cp">%}</span><span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span> <span class="na">href=</span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">MEDIA_URL</span> <span class="cp">}}</span><span class="s">myplugin/css/astylesheet.css&quot;</span><span class="nt">&gt;</span><span class="cp">{%</span> <span class="k">endaddtoblock</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">addtoblock</span> <span class="s2">&quot;js&quot;</span> <span class="cp">%}</span>
<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
    <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
        <span class="nx">doSomething</span><span class="p">();</span>
    <span class="p">});</span>
<span class="nt">&lt;/script&gt;</span>
<span class="cp">{%</span> <span class="k">endaddtoblock</span> <span class="cp">%}</span>
</pre></div>
</div>
<p>A <strong>bad</strong> example:</p>
<div class="highlight-html+django"><div class="highlight"><pre><span class="cp">{%</span> <span class="k">load</span> <span class="nv">sekizai_tags</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">addtoblock</span> <span class="s2">&quot;js&quot;</span> <span class="cp">%}</span><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">MEDIA_URL</span> <span class="cp">}}</span><span class="s">myplugin/js/myjsfile.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">MEDIA_URL</span> <span class="cp">}}</span><span class="s">myplugin/js/myotherfile.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span><span class="cp">{%</span> <span class="k">endaddtoblock</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">addtoblock</span> <span class="s2">&quot;css&quot;</span> <span class="cp">%}</span>
    <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span> <span class="na">href=</span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">MEDIA_URL</span> <span class="cp">}}</span><span class="s">myplugin/css/astylesheet.css&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="cp">{%</span> <span class="k">endaddtoblock</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">addtoblock</span> <span class="s2">&quot;js&quot;</span> <span class="cp">%}</span><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
    <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
        <span class="nx">doSomething</span><span class="p">();</span>
    <span class="p">});</span>
<span class="nt">&lt;/script&gt;</span><span class="cp">{%</span> <span class="k">endaddtoblock</span> <span class="cp">%}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="plugin-context">
<span id="plugin-context-processors"></span><h3>Plugin Context<a class="headerlink" href="#plugin-context" title="Permalink to this headline">¶</a></h3>
<p>The plugin has access to the django template context. You can override
variables using the <code class="docutils literal"><span class="pre">with</span></code> tag.</p>
<p>Example:</p>
<div class="highlight-python"><div class="highlight"><pre>{% with 320 as width %}{% placeholder &quot;content&quot; %}{% endwith %}
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h3>Plugin Context Processors<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>Plugin context processors are callables that modify all plugins&#8217; context before
rendering. They are enabled using the <a class="reference internal" href="../reference/configuration.html#std:setting-CMS_PLUGIN_CONTEXT_PROCESSORS"><code class="xref std std-setting docutils literal"><span class="pre">CMS_PLUGIN_CONTEXT_PROCESSORS</span></code></a>
setting.</p>
<p>A plugin context processor takes 3 arguments:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">instance</span></code>: The instance of the plugin model</li>
<li><code class="docutils literal"><span class="pre">placeholder</span></code>: The instance of the placeholder this plugin appears in.</li>
<li><code class="docutils literal"><span class="pre">context</span></code>: The context that is in use, including the request.</li>
</ul>
<p>The return value should be a dictionary containing any variables to be added to
the context.</p>
<p>Example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">add_verbose_name</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">placeholder</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This plugin context processor adds the plugin model&#39;s verbose_name to context.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="p">{</span><span class="s">&#39;verbose_name&#39;</span><span class="p">:</span> <span class="n">instance</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">verbose_name</span><span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="plugin-processors">
<h3>Plugin Processors<a class="headerlink" href="#plugin-processors" title="Permalink to this headline">¶</a></h3>
<p>Plugin processors are callables that modify all plugins&#8217; output after rendering.
They are enabled using the <a class="reference internal" href="../reference/configuration.html#std:setting-CMS_PLUGIN_PROCESSORS"><code class="xref std std-setting docutils literal"><span class="pre">CMS_PLUGIN_PROCESSORS</span></code></a> setting.</p>
<p>A plugin processor takes 4 arguments:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">instance</span></code>: The instance of the plugin model</li>
<li><code class="docutils literal"><span class="pre">placeholder</span></code>: The instance of the placeholder this plugin appears in.</li>
<li><code class="docutils literal"><span class="pre">rendered_content</span></code>: A string containing the rendered content of the plugin.</li>
<li><code class="docutils literal"><span class="pre">original_context</span></code>: The original context for the template used to render
the plugin.</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Plugin processors are also applied to plugins embedded in Text
plugins (and any custom plugin allowing nested plugins). Depending on
what your processor does, this might break the output. For example,
if your processor wraps the output in a <code class="docutils literal"><span class="pre">div</span></code> tag, you might end up
having <code class="docutils literal"><span class="pre">div</span></code> tags inside of <code class="docutils literal"><span class="pre">p</span></code> tags, which is invalid. You can
prevent such cases by returning <code class="docutils literal"><span class="pre">rendered_content</span></code> unchanged if
<code class="docutils literal"><span class="pre">instance._render_meta.text_enabled</span></code> is <code class="docutils literal"><span class="pre">True</span></code>, which is the case
when rendering an embedded plugin.</p>
</div>
<div class="section" id="example">
<h4>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h4>
<p>Suppose you want to wrap each plugin in the main placeholder in a colored box
but it would be too complicated to edit each individual plugin&#8217;s template:</p>
<p>In your <code class="docutils literal"><span class="pre">settings.py</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">CMS_PLUGIN_PROCESSORS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s">&#39;yourapp.cms_plugin_processors.wrap_in_colored_box&#39;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>In your <code class="docutils literal"><span class="pre">yourapp.cms_plugin_processors.py</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">wrap_in_colored_box</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">placeholder</span><span class="p">,</span> <span class="n">rendered_content</span><span class="p">,</span> <span class="n">original_context</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This plugin processor wraps each plugin&#39;s output in a colored box if it is in the &quot;main&quot; placeholder.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c"># Plugins not in the main placeholder should remain unchanged</span>
    <span class="c"># Plugins embedded in Text should remain unchanged in order not to break output</span>
    <span class="k">if</span> <span class="n">placeholder</span><span class="o">.</span><span class="n">slot</span> <span class="o">!=</span> <span class="s">&#39;main&#39;</span> <span class="ow">or</span> <span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">_render_meta</span><span class="o">.</span><span class="n">text_enabled</span> <span class="ow">and</span> <span class="n">instance</span><span class="o">.</span><span class="n">parent</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">rendered_content</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">django.template</span> <span class="kn">import</span> <span class="n">Context</span><span class="p">,</span> <span class="n">Template</span>
        <span class="c"># For simplicity&#39;s sake, construct the template from a string:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="s">&#39;&lt;div style=&quot;border: 10px {{ border_color }} solid; background: {{ background_color }};&quot;&gt;{{ content|safe }}&lt;/div&gt;&#39;</span><span class="p">)</span>
        <span class="c"># Prepare that template&#39;s context:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">Context</span><span class="p">({</span>
            <span class="s">&#39;content&#39;</span><span class="p">:</span> <span class="n">rendered_content</span><span class="p">,</span>
            <span class="c"># Some plugin models might allow you to customise the colors,</span>
            <span class="c"># for others, use default colors:</span>
            <span class="s">&#39;background_color&#39;</span><span class="p">:</span> <span class="n">instance</span><span class="o">.</span><span class="n">background_color</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="s">&#39;background_color&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s">&#39;lightyellow&#39;</span><span class="p">,</span>
            <span class="s">&#39;border_color&#39;</span><span class="p">:</span> <span class="n">instance</span><span class="o">.</span><span class="n">border_color</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="s">&#39;border_color&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s">&#39;lightblue&#39;</span><span class="p">,</span>
        <span class="p">})</span>
        <span class="c"># Finally, render the content through that template, and return the output</span>
        <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="nested-plugins">
<h3>Nested Plugins<a class="headerlink" href="#nested-plugins" title="Permalink to this headline">¶</a></h3>
<p>You can nest CMS Plugins in themselves. There&#8217;s a few things required to
achieve this functionality:</p>
<p><code class="docutils literal"><span class="pre">models.py</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ParentPlugin</span><span class="p">(</span><span class="n">CMSPlugin</span><span class="p">):</span>
    <span class="c"># add your fields here</span>

<span class="k">class</span> <span class="nc">ChildPlugin</span><span class="p">(</span><span class="n">CMSPlugin</span><span class="p">):</span>
    <span class="c"># add your fields here</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">cms_plugins.py</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">ParentPlugin</span><span class="p">,</span> <span class="n">ChildPlugin</span>

<span class="k">class</span> <span class="nc">ParentCMSPlugin</span><span class="p">(</span><span class="n">CMSPluginBase</span><span class="p">):</span>
    <span class="n">render_template</span> <span class="o">=</span> <span class="s">&#39;parent.html&#39;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;Parent&#39;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">ParentPlugin</span>
    <span class="n">allow_children</span> <span class="o">=</span> <span class="bp">True</span>  <span class="c"># This enables the parent plugin to accept child plugins</span>
    <span class="c"># You can also specify a list of plugins that are accepted as children,</span>
    <span class="c"># or leave it away completely to accept all</span>
    <span class="c"># child_classes = [&#39;ChildCMSPlugin&#39;]</span>

    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">placeholder</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">ParentCMSPlugin</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">placeholder</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">context</span>

<span class="n">plugin_pool</span><span class="o">.</span><span class="n">register_plugin</span><span class="p">(</span><span class="n">ParentCMSPlugin</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ChildCMSPlugin</span><span class="p">(</span><span class="n">CMSPluginBase</span><span class="p">):</span>
    <span class="n">render_template</span> <span class="o">=</span> <span class="s">&#39;child.html&#39;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;Child&#39;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">ChildPlugin</span>
    <span class="n">require_parent</span> <span class="o">=</span> <span class="bp">True</span>  <span class="c"># Is it required that this plugin is a child of another plugin?</span>
    <span class="c"># You can also specify a list of plugins that are accepted as parents,</span>
    <span class="c"># or leave it away completely to accept all</span>
    <span class="c"># parent_classes = [&#39;ParentCMSPlugin&#39;]</span>

    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">placeholder</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">ChildCMSPlugin</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">placeholder</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">context</span>

<span class="n">plugin_pool</span><span class="o">.</span><span class="n">register_plugin</span><span class="p">(</span><span class="n">ChildCMSPlugin</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">parent.html</span></code>:</p>
<div class="highlight-html+django"><div class="highlight"><pre><span class="cp">{%</span> <span class="k">load</span> <span class="nv">cms_tags</span> <span class="cp">%}</span>

<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;plugin parent&quot;</span><span class="nt">&gt;</span>
    <span class="cp">{%</span> <span class="k">for</span> <span class="nv">plugin</span> <span class="k">in</span> <span class="nv">instance.child_plugin_instances</span> <span class="cp">%}</span>
        <span class="cp">{%</span> <span class="k">render_plugin</span> <span class="nv">plugin</span> <span class="cp">%}</span>
    <span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>
<p><cite>child.html</cite>:</p>
<div class="highlight-html+django"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;plugin child&quot;</span><span class="nt">&gt;</span>
    <span class="cp">{{</span> <span class="nv">instance</span> <span class="cp">}}</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="extending-context-menus-of-placeholders-or-plugins">
<span id="extending-context-menus"></span><h3>Extending context menus of placeholders or plugins<a class="headerlink" href="#extending-context-menus-of-placeholders-or-plugins" title="Permalink to this headline">¶</a></h3>
<p>There are three possibilities to extend the context menus
of placeholders or plugins.</p>
<ul class="simple">
<li>You can either extend a placeholder context menu.</li>
<li>You can extend all plugin context menus.</li>
<li>You can extend the current plugin context menu.</li>
</ul>
<p>For this purpose you can overwrite 3 methods on CMSPluginBase.</p>
<ul class="simple">
<li><a class="reference internal" href="../reference/plugins.html#get-extra-placeholder-menu-items"><span>get_extra_placeholder_menu_items</span></a></li>
<li><a class="reference internal" href="../reference/plugins.html#get-extra-global-plugin-menu-items"><span>get_extra_global_plugin_menu_items</span></a></li>
<li><a class="reference internal" href="../reference/plugins.html#get-extra-local-plugin-menu-items"><span>get_extra_local_plugin_menu_items</span></a></li>
</ul>
<p>Example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AliasPlugin</span><span class="p">(</span><span class="n">CMSPluginBase</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s">&quot;Alias&quot;</span><span class="p">)</span>
    <span class="n">allow_children</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">AliasPluginModel</span>
    <span class="n">render_template</span> <span class="o">=</span> <span class="s">&quot;cms/plugins/alias.html&quot;</span>

    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">placeholder</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">AliasPlugin</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">placeholder</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">instance</span><span class="o">.</span><span class="n">plugin_id</span><span class="p">:</span>
            <span class="n">plugins</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">plugin</span><span class="o">.</span><span class="n">get_descendants</span><span class="p">(</span><span class="n">include_self</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;placeholder&#39;</span><span class="p">,</span> <span class="s">&#39;tree_id&#39;</span><span class="p">,</span> <span class="s">&#39;level&#39;</span><span class="p">,</span>
                                                                                  <span class="s">&#39;position&#39;</span><span class="p">)</span>
            <span class="n">plugins</span> <span class="o">=</span> <span class="n">downcast_plugins</span><span class="p">(</span><span class="n">plugins</span><span class="p">)</span>
            <span class="n">plugins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">parent_id</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">plugins</span> <span class="o">=</span> <span class="n">build_plugin_tree</span><span class="p">(</span><span class="n">plugins</span><span class="p">)</span>
            <span class="n">context</span><span class="p">[</span><span class="s">&#39;plugins&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plugins</span>
        <span class="k">if</span> <span class="n">instance</span><span class="o">.</span><span class="n">alias_placeholder_id</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">render_placeholder</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">alias_placeholder</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">print</span> <span class="n">content</span>
            <span class="n">context</span><span class="p">[</span><span class="s">&#39;content&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mark_safe</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">context</span>

    <span class="k">def</span> <span class="nf">get_extra_global_plugin_menu_items</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">plugin</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">PluginMenuItem</span><span class="p">(</span>
                <span class="n">_</span><span class="p">(</span><span class="s">&quot;Create Alias&quot;</span><span class="p">),</span>
                <span class="n">reverse</span><span class="p">(</span><span class="s">&quot;admin:cms_create_alias&quot;</span><span class="p">),</span>
                <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;plugin_id&#39;</span><span class="p">:</span> <span class="n">plugin</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="s">&#39;csrfmiddlewaretoken&#39;</span><span class="p">:</span> <span class="n">get_token</span><span class="p">(</span><span class="n">request</span><span class="p">)},</span>
            <span class="p">)</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_extra_placeholder_menu_items</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">placeholder</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">PluginMenuItem</span><span class="p">(</span>
                <span class="n">_</span><span class="p">(</span><span class="s">&quot;Create Alias&quot;</span><span class="p">),</span>
                <span class="n">reverse</span><span class="p">(</span><span class="s">&quot;admin:cms_create_alias&quot;</span><span class="p">),</span>
                <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;placeholder_id&#39;</span><span class="p">:</span> <span class="n">placeholder</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="s">&#39;csrfmiddlewaretoken&#39;</span><span class="p">:</span> <span class="n">get_token</span><span class="p">(</span><span class="n">request</span><span class="p">)},</span>
            <span class="p">)</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_plugin_urls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^create_alias/$&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_alias</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;cms_create_alias&#39;</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">urlpatterns</span>

    <span class="k">def</span> <span class="nf">create_alias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_staff</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">(</span><span class="s">&quot;not enough privileges&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s">&#39;plugin_id&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span> <span class="ow">and</span> <span class="ow">not</span> <span class="s">&#39;placeholder_id&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HttpResponseBadRequest</span><span class="p">(</span><span class="s">&quot;plugin_id or placeholder_id POST parameter missing.&quot;</span><span class="p">)</span>
        <span class="n">plugin</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">placeholder</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="s">&#39;plugin_id&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
            <span class="n">pk</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">&#39;plugin_id&#39;</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">plugin</span> <span class="o">=</span> <span class="n">CMSPlugin</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">CMSPlugin</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">HttpResponseBadRequest</span><span class="p">(</span><span class="s">&quot;plugin with id </span><span class="si">%s</span><span class="s"> not found.&quot;</span> <span class="o">%</span> <span class="n">pk</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&#39;placeholder_id&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
            <span class="n">pk</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">&#39;placeholder_id&#39;</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">placeholder</span> <span class="o">=</span> <span class="n">Placeholder</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">Placeholder</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">HttpResponseBadRequest</span><span class="p">(</span><span class="s">&quot;placeholder with id </span><span class="si">%s</span><span class="s"> not found.&quot;</span> <span class="o">%</span> <span class="n">pk</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">placeholder</span><span class="o">.</span><span class="n">has_change_permission</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">HttpResponseBadRequest</span><span class="p">(</span><span class="s">&quot;You do not have enough permission to alias this placeholder.&quot;</span><span class="p">)</span>
        <span class="n">clipboard</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">toolbar</span><span class="o">.</span><span class="n">clipboard</span>
        <span class="n">clipboard</span><span class="o">.</span><span class="n">cmsplugin_set</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="n">language</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">LANGUAGE_CODE</span>
        <span class="k">if</span> <span class="n">plugin</span><span class="p">:</span>
            <span class="n">language</span> <span class="o">=</span> <span class="n">plugin</span><span class="o">.</span><span class="n">language</span>
        <span class="n">alias</span> <span class="o">=</span> <span class="n">AliasPluginModel</span><span class="p">(</span><span class="n">language</span><span class="o">=</span><span class="n">language</span><span class="p">,</span> <span class="n">placeholder</span><span class="o">=</span><span class="n">clipboard</span><span class="p">,</span> <span class="n">plugin_type</span><span class="o">=</span><span class="s">&quot;AliasPlugin&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plugin</span><span class="p">:</span>
            <span class="n">alias</span><span class="o">.</span><span class="n">plugin</span> <span class="o">=</span> <span class="n">plugin</span>
        <span class="k">if</span> <span class="n">placeholder</span><span class="p">:</span>
            <span class="n">alias</span><span class="o">.</span><span class="n">alias_placeholder</span> <span class="o">=</span> <span class="n">placeholder</span>
        <span class="n">alias</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s">&quot;ok&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="plugin-data-migrations">
<span id="plugin-datamigrations-3-1"></span><h3>Plugin data migrations<a class="headerlink" href="#plugin-data-migrations" title="Permalink to this headline">¶</a></h3>
<p>Due to the migration from Django MPTT to django-treebeard in version 3.1, the plugin model is
different between the two versions. Schema migration are not affected as the migration systems
(both South and Django) detects the different bases.</p>
<p>Data migration are a different story, though.</p>
<p>If your data migration does something like:</p>
<div class="highlight-django"><div class="highlight"><pre><span class="x">MyPlugin = apps.get_model(&#39;my_app&#39;, &#39;MyPlugin&#39;)</span>

<span class="x">for plugin in MyPlugin.objects.all():</span>
<span class="x">    ... do something ...</span>
</pre></div>
</div>
<p>You may end up with an error like
<code class="docutils literal"><span class="pre">django.db.utils.OperationalError:</span> <span class="pre">(1054,</span> <span class="pre">&quot;Unknown</span> <span class="pre">column</span> <span class="pre">'cms_cmsplugin.level'</span> <span class="pre">in</span> <span class="pre">'field</span> <span class="pre">list'&quot;)</span></code>
because depending on the order the migrations are executed, the historical models may be out of
sync with the applied database schema.</p>
<p>To keep compatibility with 3.0 and 3.x you can force the data migration to run before the django CMS
migration that creates treebeard fields, by doing this the data migration will always be executed
on the &#8220;old&#8221; database schema and no conflict will exist.</p>
<p>For South migrations add this:</p>
<div class="highlight-django"><div class="highlight"><pre><span class="x">from distutils.version import LooseVersion</span>
<span class="x">import cms</span>
<span class="x">USES_TREEBEARD = LooseVersion(cms.__version__) &gt;= LooseVersion(&#39;3.1&#39;)</span>

<span class="x">class Migration(DataMigration):</span>

<span class="x">    if USES_TREEBEARD:</span>
<span class="x">        needed_by = [</span>
<span class="x">            (&#39;cms&#39;, &#39;0070_auto__add_field_cmsplugin_path__add_field_cmsplugin_depth__add_field_c&#39;)</span>
<span class="x">        ]</span>
</pre></div>
</div>
<p>For Django migrations add this:</p>
<div class="highlight-django"><div class="highlight"><pre><span class="x">from distutils.version import LooseVersion</span>
<span class="x">import cms</span>
<span class="x">USES_TREEBEARD = LooseVersion(cms.__version__) &gt;= LooseVersion(&#39;3.1&#39;)</span>

<span class="x">class Migration(migrations.Migration):</span>

<span class="x">    if USES_TREEBEARD:</span>
<span class="x">        run_before = [</span>
<span class="x">            (&#39;cms&#39;, &#39;0004_auto_20140924_1038&#39;)</span>
<span class="x">        ]</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="menus.html" class="btn btn-neutral float-right" title="Customising navigation menus" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="install.html" class="btn btn-neutral" title="Installing django CMS by hand" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2009-2015, Patrick Lauber.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'3.3.0.dev4',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>