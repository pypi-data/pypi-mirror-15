<!--
# Copyright (c) Jupyter Development Team.
# Distributed under the terms of the Modified BSD License.
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../urth-core-behaviors/jupyter-widget-behavior.html">
<link rel="import" href="../urth-core-behaviors/execution-complete-behavior.html">

<!--
This element represents a DataFrame. The `ref` property points to an instance of a DataFrame in the
kernel. Currently, there is support for:

* Pandas DataFrame
* PySpark DataFrame
* Spark DataFrame in Scala
* R DataFrame
* Spark DataFrame in R

The data for the DataFrame is available in a variety of way:

* The `value` property has an Object representation of the DataFrame.
* The `rows` property has only the data portion of the DataFrame and can be structured as a 2D Array or
an Array of Objects.
* The `columns` property has an Array of column names

The amount of data rows that is made available to this element from the kernel instance is controled by
the `limit` property.

Example:

    <urth-core-dataframe id="f1" ref="aDataFrame" value="{{df}}" auto></urth-core-dataframe>

    <urth-core-dataframe id="f1" ref="aDataFrame" rows="{{rows}}" columns="{{cols}}" auto></urth-core-dataframe>

    <urth-core-dataframe id="f1" ref="aDataFrame" rows="{{rows}}" rows-as-object auto></urth-core-dataframe>

@group Urth Core
@element urth-core-dataframe
-->
<script>

(function(){
    'use strict';

    window.Urth = window.Urth || {};

    window.Urth['urth-core-dataframe'] = Polymer({
        is: 'urth-core-dataframe',

        properties: {

            /**
             * The name of the DataFrame variable that this element
             * will bind to.
             */
            ref: {
                type: String,
                value: ''
            },

            /**
             * The serialized representation of the DataFrame `ref`. The structure contains:
             * {
             *  columns: Array of column names
             *  data: 2D Array of rows with column values
             *  index: Array with index values
             * }
             */
            value: {
                type: Object,
                readOnly: true,
                notify: true
            },

            /**
             * An Array with the column names for the DataFrame
             */
            columns: {
                type: Array,
                computed: '_columns(value)',
                notify: true
            },

            /**
             * An Array containing the data rows of the DataFrame. If 'row-as-object` is false, this
             * property will contain a 2D Array where the outer Array contains each row and the inner Array contains
             * the values for each column in the order defined by the `columns` property. If 'row-as-object` is true,
             * this property will contain an Array of Objects, where each Object represents a row of data with column
             * values keyed by column names.
             */
            rows: {
                type: Array,
                computed: '_rows(value, rowAsObject)',
                notify: true
            },

            /**
             * Controls the shape of the `rows` property. If true, `rows` is an Array of Objects, else `rows` is a 2D
             * Array.
             */
            rowAsObject:{
                type: Boolean,
                value: false
            },

            /**
             * Toggles automatic updates upon the completion of code execution.
             */
            auto: {
                type: Boolean,
                value: false
            },

            /**
             * Sets the maximun number of rows to bring to the client.
             */
            limit: {
              type: Number,
              value: 100,
              reflectToAttribute: true,
              observer: '_onLimitChange'
            }
        },

        behaviors: [
            Urth.JupyterWidgetBehavior,
            Urth.ExecutionCompleteBehavior
        ],

        listeners: {
            'watch_notify': 'refresh'
        },

        created: function(){
            console.debug('urth-core-datafram created', arguments);
            this.createModel('urth.widgets.widget_dataframe.DataFrame');
        },

        ready: function() {
            console.debug("urth-core-dataframe ready");
        },

        /*
         * onModelReady is invoked when have created the model portion of the widget
         */
        onModelReady: function(){
            console.debug('urth-core-dataframe onModelReady');

            var syncData = {
                variable_name: this.ref,
                limit: this.limit
            }
            console.debug('urth-core-dataframe sending initial sync', syncData);
            this.sync(syncData);

            this.refresh();
        },

        /*
         * onModelValueChange is invoked by JupyterWidgetBehavior when the `value` `property in
         * the Backbone model changes.
         */
        onModelValueChange: function(newVal){
            console.debug( "urth-core-dataframe onModelValueChange", newVal );
            this._setValue(newVal || {data:[]});
        },

        /* 
         * to override onModel__status__Change in jupyter-widget-behavior.html
         * We need to clear error message on status ok
         */
        onModel__status__Change: function(newStatus) {
            if (newStatus.status === "ok") {
              this._clearErrorMessages();
            } else {
              this.displayErrorMessage(newStatus.msg);
            }
        },

        _onExecutionComplete: function(){
            if (this.auto) {
                this.refresh();
            }
        },

        /**
         * Update the DataFrame `value` held by this element with
         * the DataFrame's current state on the kernel.
         *
         * @method refresh
         */
        refresh: function() {
            var jName = "urth-core-dataframe.refresh";
            if( this.isDebouncerActive(jName) ) {
                this.cancelDebouncer(jName);
            }

            this.debounce(jName, function(){
              console.debug("urth-core-dataframe sending sync message...");
              this.send({ "event": "sync" });
            }.bind(this), 200);
        },

        /**
         * Returns the columns portion of the serialized DataFrame
         * @param df - the serialized DataFrame
         * @return the columns array
         * @private
         */
        _columns: function(df){
            return df.columns;
        },

        /**
         * Returns the data portion of the serialized DataFrame as a 2D array or as an Array of Objects depending on the
         * value of `rowAsObject`.
         * @param df - the serialized DataFrame
         * @param rowAsObject
         * @private
         */
        _rows: function(df, rowAsObject){
            return !rowAsObject
                        ? df.data
                        : df.data.map(function(row){
                            var rowObj = {};
                            row.forEach(function(col, idx){
                                rowObj[df.columns[idx]] = col;
                            })
                            return rowObj;
                        });
        },

        _onLimitChange: function(){
            console.debug('urth-core-dataframe sending new limit value', this.limit);
            this.sync({limit: this.limit});
            this.refresh();
        }

    });
})();
</script>
