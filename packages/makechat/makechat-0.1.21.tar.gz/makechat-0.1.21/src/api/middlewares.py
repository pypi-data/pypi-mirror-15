"""All middlewares should be described here."""

import bson.json_util as json
import falcon


class RequireJSON:
    """Check incoming requests type."""

    error_msg = falcon.HTTPNotAcceptable(
        'This API only supports responses encoded as JSON.',
        href='http://docs.examples.com/api/json')

    def process_request(self, req, resp):
        """Process each request."""
        if not req.content_type:
            raise self.error_msg

        if not req.client_accepts_json:
            raise self.error_msg

        if req.method in ('POST', 'PUT'):
            if 'application/json' not in req.content_type:
                raise self.error_msg


class JSONTranslator:
    """Process JSON of incoming requests."""

    def process_request(self, req, resp):
        """Process each request."""
        if req.content_length in (None, 0):
            return

        body = req.stream.read()
        if not body:
            raise falcon.HTTPBadRequest('Empty request body',
                                        'A valid JSON document is required.')
        try:
            req.context['payload'] = json.loads(body.decode('utf-8'))
        except Exception as er:
            raise falcon.HTTPError(falcon.HTTP_753, 'Malformed JSON', str(er))

    def process_response(self, req, resp, resource):
        """Process each response."""
        if 'result' in req.context:
            resp.body = json.dumps(req.context['result'])

        if falcon.HTTP_300 >= resp.status >= falcon.HTTP_200:
            if not resp.body:
                resp.body = json.dumps({'status': 'ok'})
